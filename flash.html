<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ü—Ä–æ—à–∏–≤–∫–∞ ESP32 ‚Äî Power Monitor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-void: #030305;
            --bg-surface: #0a0a0f;
            --bg-elevated: #111118;
            --bg-input: #08080c;
            --electric: #fbbf24;
            --electric-dim: #b8860b;
            --electric-glow: rgba(251, 191, 36, 0.25);
            --electric-subtle: rgba(251, 191, 36, 0.08);
            --success: #10b981;
            --success-glow: rgba(16, 185, 129, 0.25);
            --danger: #ef4444;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-tertiary: #52525b;
            --border: rgba(251, 191, 36, 0.12);
            --border-subtle: rgba(255,255,255,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            background: var(--bg-void);
        }

        body {
            font-family: 'Outfit', system-ui, sans-serif;
            background: var(--bg-void);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Circuit board pattern background */
        .circuit-bg {
            position: fixed;
            inset: 0;
            opacity: 0.4;
            pointer-events: none;
            background:
                linear-gradient(90deg, transparent 49.5%, var(--electric-subtle) 49.5%, var(--electric-subtle) 50.5%, transparent 50.5%),
                linear-gradient(0deg, transparent 49.5%, var(--electric-subtle) 49.5%, var(--electric-subtle) 50.5%, transparent 50.5%);
            background-size: 60px 60px;
            mask-image: radial-gradient(ellipse 80% 60% at 50% 0%, black 0%, transparent 70%);
        }

        /* Animated glow orb */
        .glow-orb {
            position: fixed;
            top: -200px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 400px;
            background: radial-gradient(ellipse, var(--electric-glow) 0%, transparent 70%);
            pointer-events: none;
            animation: orb-pulse 4s ease-in-out infinite;
        }

        @keyframes orb-pulse {
            0%, 100% { opacity: 0.6; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.9; transform: translateX(-50%) scale(1.1); }
        }

        /* Scanline effect */
        .scanlines {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent 0px,
                transparent 2px,
                rgba(0,0,0,0.1) 2px,
                rgba(0,0,0,0.1) 4px
            );
            z-index: 1000;
            opacity: 0.3;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 48px 24px 80px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
            color: var(--text-primary);
            margin-bottom: 32px;
            transition: transform 0.2s;
        }

        .logo:hover {
            transform: scale(1.02);
        }

        .logo-icon {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--electric) 0%, var(--electric-dim) 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow:
                0 0 40px var(--electric-glow),
                inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 16px;
            border: 1px solid var(--electric);
            opacity: 0.3;
        }

        .logo-text {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 18px;
            letter-spacing: -0.5px;
        }

        .page-title {
            font-family: 'Space Mono', monospace;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -1px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 400;
        }

        /* Browser warning */
        .browser-warning {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 32px;
            text-align: center;
            font-size: 14px;
            display: none;
            backdrop-filter: blur(10px);
        }

        .browser-warning.visible {
            display: block;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Steps */
        .step {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--electric), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .step:hover::before,
        .step.active::before {
            opacity: 0.5;
        }

        .step.completed {
            border-color: rgba(16, 185, 129, 0.3);
        }

        .step.completed::before {
            background: linear-gradient(90deg, transparent, var(--success), transparent);
            opacity: 0.5;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-elevated);
            border: 2px solid var(--electric);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 14px;
            color: var(--electric);
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .step-number.done {
            background: var(--success);
            border-color: var(--success);
            color: white;
            box-shadow: 0 0 20px var(--success-glow);
        }

        .step-title {
            font-family: 'Space Mono', monospace;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .step-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* Input */
        .input-wrapper {
            position: relative;
        }

        .form-input {
            width: 100%;
            padding: 16px 20px;
            background: var(--bg-input);
            border: 2px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--electric);
            box-shadow: 0 0 0 4px var(--electric-subtle);
            background: var(--bg-surface);
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
            font-weight: 400;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 18px 28px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--electric) 0%, var(--electric-dim) 100%);
            color: var(--bg-void);
            box-shadow: 0 4px 20px var(--electric-glow);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .btn-primary:hover:not(:disabled)::before {
            opacity: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 40px var(--electric-glow);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn.flashing {
            animation: btn-pulse 1.5s ease-in-out infinite;
        }

        @keyframes btn-pulse {
            0%, 100% { box-shadow: 0 4px 20px var(--electric-glow); }
            50% { box-shadow: 0 4px 40px var(--electric-glow), 0 0 60px var(--electric-glow); }
        }

        .btn-icon {
            font-size: 18px;
        }

        /* Progress */
        .progress-container {
            margin-top: 24px;
            display: none;
        }

        .progress-container.visible {
            display: block;
            animation: fade-in 0.3s ease;
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--electric), var(--success));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3));
            animation: progress-shine 1.5s ease-in-out infinite;
        }

        @keyframes progress-shine {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(400px); }
        }

        .progress-text {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Log */
        .flash-log {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-void);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            max-height: 180px;
            overflow-y: auto;
            display: none;
            line-height: 1.7;
        }

        .flash-log.visible {
            display: block;
            animation: fade-in 0.3s ease;
        }

        .flash-log::-webkit-scrollbar {
            width: 6px;
        }

        .flash-log::-webkit-scrollbar-track {
            background: var(--bg-surface);
            border-radius: 3px;
        }

        .flash-log::-webkit-scrollbar-thumb {
            background: var(--text-tertiary);
            border-radius: 3px;
        }

        .flash-log div {
            color: var(--text-secondary);
        }

        .flash-log .error { color: var(--danger); }
        .flash-log .success { color: var(--success); }

        /* WiFi Section */
        .wifi-section {
            margin-top: 4px;
        }

        .wifi-btn {
            width: 100%;
            padding: 18px 28px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s;
            box-shadow: 0 4px 20px var(--success-glow);
        }

        .wifi-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 40px var(--success-glow);
        }

        .wifi-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        .wifi-btn.pulse-attention {
            animation: attention-pulse 1s ease-in-out infinite;
        }

        @keyframes attention-pulse {
            0%, 100% {
                box-shadow: 0 4px 20px var(--success-glow);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 4px 40px var(--success-glow), 0 0 60px var(--success-glow);
                transform: scale(1.02);
            }
        }

        .wifi-status {
            margin-top: 16px;
            padding: 14px 18px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            font-size: 14px;
            display: none;
            color: var(--success);
        }

        .wifi-status.visible {
            display: block;
        }

        .wifi-dialog {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .wifi-dialog-content {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 360px;
        }

        .wifi-dialog h3 {
            margin: 0 0 20px 0;
            color: var(--electric);
            font-family: 'Space Mono', monospace;
        }

        .wifi-input {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 15px;
            font-family: 'Outfit', sans-serif;
            box-sizing: border-box;
        }

        .wifi-input:focus {
            outline: none;
            border-color: var(--electric);
        }

        .wifi-network-list {
            max-height: 180px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
            background: var(--bg-input);
        }

        .wifi-network-list::-webkit-scrollbar {
            width: 6px;
        }

        .wifi-network-list::-webkit-scrollbar-track {
            background: var(--bg-surface);
            border-radius: 3px;
        }

        .wifi-network-list::-webkit-scrollbar-thumb {
            background: var(--text-tertiary);
            border-radius: 3px;
        }

        .wifi-network-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border-subtle);
            transition: background 0.15s;
        }

        .wifi-network-item:last-child {
            border-bottom: none;
        }

        .wifi-network-item:hover {
            background: var(--electric-subtle);
        }

        .wifi-network-item.selected {
            background: var(--electric-subtle);
            border-left: 3px solid var(--electric);
        }

        .wifi-network-name {
            font-size: 14px;
            font-weight: 500;
        }

        .wifi-network-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .wifi-signal {
            display: flex;
            align-items: flex-end;
            gap: 2px;
            height: 14px;
        }

        .wifi-signal-bar {
            width: 3px;
            background: var(--text-tertiary);
            border-radius: 1px;
        }

        .wifi-signal-bar.active {
            background: var(--success);
        }

        .wifi-signal-bar:nth-child(1) { height: 4px; }
        .wifi-signal-bar:nth-child(2) { height: 7px; }
        .wifi-signal-bar:nth-child(3) { height: 10px; }
        .wifi-signal-bar:nth-child(4) { height: 14px; }

        .wifi-network-empty {
            padding: 20px;
            text-align: center;
            color: var(--text-tertiary);
            font-size: 13px;
        }

        .wifi-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .wifi-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .wifi-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .wifi-btn-save {
            background: var(--electric);
            color: var(--bg-void);
        }

        .wifi-btn-test {
            background: var(--success);
        }

        .wifi-log {
            background: var(--bg-void);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 12px;
            display: none;
        }

        .wifi-log.visible {
            display: block;
        }

        .wifi-log .success { color: var(--success); }
        .wifi-log .error { color: var(--danger); }

        .wifi-close {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            animation: fade-in 0.3s ease;
        }

        /* Telegram Setup */
        .telegram-section {
            margin-top: 16px;
        }

        .telegram-btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #0088cc 0%, #005580 100%);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 136, 204, 0.3);
        }

        .telegram-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(0, 136, 204, 0.4);
        }

        .telegram-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .telegram-hint {
            margin-top: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
        }

        .telegram-hint a {
            color: #0088cc;
            text-decoration: none;
        }

        .telegram-hint a:hover {
            text-decoration: underline;
        }

        .telegram-dialog {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .telegram-dialog-content {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            width: 90%;
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
            animation: dialog-appear 0.3s ease;
        }

        @keyframes dialog-appear {
            from { opacity: 0; transform: scale(0.95) translateY(10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .telegram-dialog h3 {
            margin: 0 0 24px 0;
            color: #0088cc;
            font-family: 'Space Mono', monospace;
            font-size: 18px;
            text-align: center;
        }

        /* Step indicator */
        .tg-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 28px;
            padding: 16px;
            background: var(--bg-surface);
            border-radius: 12px;
        }

        .tg-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            opacity: 0.4;
            transition: opacity 0.3s;
        }

        .tg-step.active {
            opacity: 1;
        }

        .tg-step.done {
            opacity: 1;
        }

        .tg-step-num {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 2px solid var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.3s;
        }

        .tg-step.active .tg-step-num {
            border-color: #0088cc;
            color: #0088cc;
        }

        .tg-step.done .tg-step-num {
            background: #0088cc;
            border-color: #0088cc;
            color: white;
        }

        .tg-step-label {
            font-size: 11px;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tg-step.active .tg-step-label {
            color: #0088cc;
        }

        .tg-step-line {
            width: 40px;
            height: 2px;
            background: var(--border-subtle);
            margin-bottom: 20px;
        }

        /* Instruction blocks */
        .tg-instruction {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-surface);
            border-radius: 10px;
            border-left: 3px solid #0088cc;
        }

        .tg-instruction-num {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 136, 204, 0.15);
            color: #0088cc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .tg-instruction-text {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .tg-instruction-text code {
            background: var(--bg-elevated);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            color: #0088cc;
        }

        .tg-link {
            color: #0088cc;
            text-decoration: none;
            font-weight: 600;
        }

        .tg-link:hover {
            text-decoration: underline;
        }

        /* Input */
        .tg-input {
            width: 100%;
            padding: 14px 16px;
            margin: 16px 0;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Space Mono', monospace;
        }

        .tg-input:focus {
            outline: none;
            border-color: #0088cc;
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.15);
        }

        .tg-input::placeholder {
            color: var(--text-tertiary);
        }

        /* Buttons */
        .tg-btn {
            width: 100%;
            padding: 14px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .tg-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tg-btn-primary {
            background: linear-gradient(135deg, #0088cc 0%, #006699 100%);
            color: white;
        }

        .tg-btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.4);
        }

        .tg-btn-secondary {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
        }

        .tg-btn-secondary:hover:not(:disabled) {
            border-color: #0088cc;
            color: #0088cc;
        }

        .tg-btn-icon {
            font-size: 16px;
        }

        /* Bot info card */
        .tg-bot-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-surface);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 136, 204, 0.3);
        }

        .tg-bot-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0088cc 0%, #005580 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .tg-bot-details {
            flex: 1;
        }

        .tg-bot-name {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }

        .tg-bot-username {
            font-size: 13px;
            color: #0088cc;
            font-family: 'Space Mono', monospace;
        }

        .tg-bot-check {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--success);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
        }

        /* Chat list */
        .tg-chat-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-top: 16px;
            background: var(--bg-input);
        }

        .tg-chat-item {
            padding: 14px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-subtle);
            transition: background 0.15s;
        }

        .tg-chat-item:last-child {
            border-bottom: none;
        }

        .tg-chat-item:hover {
            background: rgba(0, 136, 204, 0.1);
        }

        .tg-chat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-elevated);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .tg-chat-info {
            flex: 1;
        }

        .tg-chat-name {
            font-weight: 500;
            font-size: 14px;
        }

        .tg-chat-type {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .tg-chat-empty {
            padding: 20px;
            text-align: center;
            color: var(--text-tertiary);
            font-size: 14px;
        }

        /* Success state */
        .tg-success-icon {
            font-size: 64px;
            text-align: center;
            margin-bottom: 16px;
            animation: success-bounce 0.5s ease;
        }

        @keyframes success-bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .tg-success-title {
            font-family: 'Space Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            color: var(--success);
            margin-bottom: 8px;
        }

        .tg-success-desc {
            text-align: center;
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .tg-selected-chat {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-surface);
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .tg-selected-chat .tg-chat-icon {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .tg-selected-chat .tg-chat-name {
            color: var(--text-primary);
        }

        .tg-selected-chat .tg-chat-id {
            font-size: 12px;
            color: var(--text-tertiary);
            font-family: 'Space Mono', monospace;
        }

        /* Status & Log */
        .tg-status {
            margin-top: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            display: none;
        }

        .tg-status.success {
            display: block;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

        .tg-status.error {
            display: block;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: var(--danger);
        }

        .tg-log {
            background: var(--bg-void);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
            margin: 16px 0;
            display: none;
        }

        .tg-log.visible {
            display: block;
        }

        .tg-close {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .tg-close:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
        }

        .telegram-status {
            margin-top: 16px;
            padding: 14px 18px;
            background: rgba(0, 136, 204, 0.1);
            border: 1px solid rgba(0, 136, 204, 0.3);
            border-radius: 10px;
            font-size: 14px;
            display: none;
            color: #0088cc;
        }

        .telegram-status.visible {
            display: block;
        }

        .telegram-status.success {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--success);
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
        }

        .footer-link {
            color: var(--text-tertiary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .footer-link:hover {
            color: var(--electric);
        }

        /* Connection line between steps */
        .step-connector {
            width: 2px;
            height: 20px;
            background: var(--border-subtle);
            margin: 0 auto;
            position: relative;
        }

        .step-connector::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--bg-surface);
            border: 2px solid var(--border-subtle);
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="circuit-bg"></div>
    <div class="glow-orb"></div>
    <div class="scanlines"></div>

    <div class="container">
        <div class="header">
            <a href="/" class="logo">
                <div class="logo-icon">‚ö°</div>
                <span class="logo-text">Power Monitor</span>
            </a>
            <h1 class="page-title">–ü—Ä–æ—à–∏–≤–∫–∞ ESP32</h1>
            <p class="page-subtitle">–í—Å—Ç–∞–Ω–æ–≤–∏ –ø—Ä–æ—à–∏–≤–∫—É —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–π WiFi</p>
        </div>

        <div class="browser-warning" id="browserWarning">
            ‚ö†Ô∏è –¶–µ–π –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î Web Serial. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π <strong>Chrome</strong> –∞–±–æ <strong>Edge</strong> –Ω–∞ –∫–æ–º–ø'—é—Ç–µ—Ä—ñ.
        </div>

        <!-- Step 1: Device Name -->
        <div class="step" id="step1">
            <div class="step-header">
                <div class="step-number" id="step1num">1</div>
                <div class="step-title">–ù–∞–∑–≤–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é</div>
            </div>
            <div class="step-desc">–í–≤–µ–¥–∏ –Ω–∞–∑–≤—É –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó ‚Äî –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, ¬´–ö–≤–∞—Ä—Ç–∏—Ä–∞¬ª –∞–±–æ ¬´–î–∞—á–∞¬ª</div>
            <div class="input-wrapper">
                <input type="text" class="form-input" id="deviceName" placeholder="–í–≤–µ–¥–∏ –Ω–∞–∑–≤—É –ø—Ä–∏—Å—Ç—Ä–æ—é" maxlength="40" autocomplete="off" spellcheck="false">
            </div>
        </div>

        <div class="step-connector"></div>

        <!-- Step 2: Flash -->
        <div class="step" id="step2">
            <div class="step-header">
                <div class="step-number" id="step2num">2</div>
                <div class="step-title">–ü—Ä–æ—à–∏–≤–∫–∞</div>
            </div>
            <div class="step-desc">–ü—ñ–¥–∫–ª—é—á–∏ ESP32 –¥–æ USB —Ç–∞ –Ω–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É –ø—Ä–æ—à–∏–≤–∫–∏</div>

            <button class="btn btn-primary" id="flashBtn" disabled>
                <span class="btn-icon">‚ö°</span>
                <span id="flashBtnText">–ü—Ä–æ—à–∏—Ç–∏ ESP32</span>
            </button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
            </div>

            <div class="flash-log" id="flashLog"></div>
        </div>

        <div class="step-connector"></div>

        <!-- Step 3: WiFi -->
        <div class="step" id="step3">
            <div class="step-header">
                <div class="step-number" id="step3num">3</div>
                <div class="step-title">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è WiFi</div>
            </div>
            <div class="step-desc">–ü—ñ—Å–ª—è –ø—Ä–æ—à–∏–≤–∫–∏ –Ω–∞–ª–∞—à—Ç—É–π WiFi –º–µ—Ä–µ–∂—É –¥–ª—è –ø—Ä–∏—Å—Ç—Ä–æ—é</div>

            <div class="wifi-section">
                <button class="wifi-btn" id="wifiBtnInner">
                    <span>üì∂</span>
                    <span>–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ WiFi</span>
                </button>

                <div id="wifiDialog" class="wifi-dialog" style="display:none;">
                    <div class="wifi-dialog-content">
                        <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è WiFi</h3>
                        <div id="wifiForm">
                            <div id="wifiNetworkList" class="wifi-network-list">
                                <div class="wifi-network-empty">–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è –º–µ—Ä–µ–∂...</div>
                            </div>
                            <input type="text" id="wifiSsid" placeholder="–ê–±–æ –≤–≤–µ–¥—ñ—Ç—å SSID –≤—Ä—É—á–Ω—É" class="wifi-input">
                            <input type="password" id="wifiPass" placeholder="–ü–∞—Ä–æ–ª—å" class="wifi-input">
                            <div class="wifi-buttons">
                                <button id="wifiSave" class="wifi-btn wifi-btn-save">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                                <button id="wifiTest" class="wifi-btn wifi-btn-test">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏</button>
                            </div>
                        </div>
                        <div id="wifiLog" class="wifi-log"></div>
                        <button id="wifiClose" class="wifi-close">–ó–∞–∫—Ä–∏—Ç–∏</button>
                    </div>
                </div>

                <div class="wifi-status" id="wifiStatus"></div>
            </div>
        </div>

        <div class="step-connector"></div>

        <!-- Step 4: Telegram -->
        <div class="step" id="step4">
            <div class="step-header">
                <div class="step-number" id="step4num">4</div>
                <div class="step-title">Telegram —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</div>
            </div>
            <div class="step-desc">–ü—ñ–¥–∫–ª—é—á–∏ —Å–≤–æ–≥–æ –±–æ—Ç–∞ –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å –ø—Ä–æ —Å–≤—ñ—Ç–ª–æ</div>

            <div class="telegram-section">
                <button class="telegram-btn" id="telegramBtnInner" disabled>
                    <span>ü§ñ</span>
                    <span>–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ Telegram</span>
                </button>
                <div class="telegram-hint">
                    –°—Ç–≤–æ—Ä–∏ —Å–≤–æ–≥–æ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ <a href="https://t.me/BotFather" target="_blank">@BotFather</a> ‚Äî –≤—ñ–Ω –±—É–¥–µ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ —Ç–æ–±—ñ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                </div>

                <div id="telegramDialog" class="telegram-dialog" style="display:none;">
                    <div class="telegram-dialog-content">
                        <h3>Telegram —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è</h3>

                        <!-- Step indicator -->
                        <div class="tg-steps">
                            <div class="tg-step active" id="tgStep1Ind">
                                <div class="tg-step-num">1</div>
                                <div class="tg-step-label">–¢–æ–∫–µ–Ω</div>
                            </div>
                            <div class="tg-step-line"></div>
                            <div class="tg-step" id="tgStep2Ind">
                                <div class="tg-step-num">2</div>
                                <div class="tg-step-label">–ß–∞—Ç</div>
                            </div>
                            <div class="tg-step-line"></div>
                            <div class="tg-step" id="tgStep3Ind">
                                <div class="tg-step-num">3</div>
                                <div class="tg-step-label">–ì–æ—Ç–æ–≤–æ</div>
                            </div>
                        </div>

                        <!-- Step 1: Bot Token -->
                        <div id="tgStep1" class="tg-panel">
                            <div class="tg-instruction">
                                <div class="tg-instruction-num">1</div>
                                <div class="tg-instruction-text">
                                    –í—ñ–¥–∫—Ä–∏–π <a href="https://t.me/BotFather" target="_blank" class="tg-link">@BotFather</a> –≤ Telegram
                                </div>
                            </div>
                            <div class="tg-instruction">
                                <div class="tg-instruction-num">2</div>
                                <div class="tg-instruction-text">
                                    –í—ñ–¥–ø—Ä–∞–≤ –∫–æ–º–∞–Ω–¥—É <code>/newbot</code> —Ç–∞ —Å–ª—ñ–¥—É–π —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º
                                </div>
                            </div>
                            <div class="tg-instruction">
                                <div class="tg-instruction-num">3</div>
                                <div class="tg-instruction-text">
                                    –°–∫–æ–ø—ñ—é–π —Ç–æ–∫–µ–Ω —Ç–∞ –≤—Å—Ç–∞–≤ —Å—é–¥–∏:
                                </div>
                            </div>
                            <input type="text" id="tgBotToken" placeholder="123456789:ABCdef..." class="tg-input">
                            <button id="tgVerifyToken" class="tg-btn tg-btn-primary">–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–æ–∫–µ–Ω</button>
                            <div id="tgTokenStatus" class="tg-status"></div>
                        </div>

                        <!-- Step 2: Find Chats -->
                        <div id="tgStep2" class="tg-panel" style="display:none;">
                            <div class="tg-bot-info" id="tgBotInfo">
                                <div class="tg-bot-avatar">ü§ñ</div>
                                <div class="tg-bot-details">
                                    <div class="tg-bot-name" id="tgBotName">Bot Name</div>
                                    <div class="tg-bot-username" id="tgBotUsername">@username</div>
                                </div>
                                <div class="tg-bot-check">‚úì</div>
                            </div>

                            <div class="tg-instruction">
                                <div class="tg-instruction-num">1</div>
                                <div class="tg-instruction-text">
                                    –î–æ–¥–∞–π –±–æ—Ç–∞ –≤ –≥—Ä—É–ø—É –∞–±–æ –∫–∞–Ω–∞–ª, –∫—É–¥–∏ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                                </div>
                            </div>
                            <div class="tg-instruction">
                                <div class="tg-instruction-num">2</div>
                                <div class="tg-instruction-text">
                                    –ù–∞–ø–∏—à–∏ –±—É–¥—å-—è–∫–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ —Ü–µ–π —á–∞—Ç
                                </div>
                            </div>

                            <button id="tgFindChats" class="tg-btn tg-btn-primary">
                                <span class="tg-btn-icon">üîç</span>
                                –ó–Ω–∞–π—Ç–∏ —á–∞—Ç–∏
                            </button>

                            <div id="tgChatList" class="tg-chat-list" style="display:none;">
                                <div class="tg-chat-empty">–®—É–∫–∞—î–º–æ —á–∞—Ç–∏...</div>
                            </div>

                            <div id="tgStep2Status" class="tg-status"></div>
                        </div>

                        <!-- Step 3: Done -->
                        <div id="tgStep3" class="tg-panel" style="display:none;">
                            <div class="tg-success-icon">üéâ</div>
                            <div class="tg-success-title">Telegram –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ!</div>
                            <div class="tg-success-desc">
                                –¢–µ–ø–µ—Ä —Ç–∏ –±—É–¥–µ—à –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –≤–∫–ª—é—á–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞
                            </div>
                            <div class="tg-selected-chat" id="tgSelectedChat">
                                <div class="tg-chat-icon">üí¨</div>
                                <div class="tg-chat-info">
                                    <div class="tg-chat-name" id="tgSelectedChatName">Chat Name</div>
                                    <div class="tg-chat-id" id="tgSelectedChatId">ID: -100...</div>
                                </div>
                            </div>
                            <button id="tgSendTest" class="tg-btn tg-btn-secondary">
                                <span>üì§</span>
                                –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                            </button>
                        </div>

                        <div id="tgLog" class="tg-log"></div>
                        <button id="telegramClose" class="tg-close">–ó–∞–∫—Ä–∏—Ç–∏</button>
                    </div>
                </div>

                <div class="telegram-status" id="telegramStatus"></div>
            </div>
        </div>

        <div class="footer">
            <a href="/" class="footer-link">
                <span>‚Üê</span>
                <span>–ù–∞ –≥–æ–ª–æ–≤–Ω—É</span>
            </a>
        </div>
    </div>

    <script type="module">
        // Use local esptool-js bundle
        import { ESPLoader, Transport } from '/esptool-bundle.js';

        // Patch Transport: setDTR buffers, setRTS sends both (like Python UnixTightReset)
        // This makes ClassicReset work like UnixTightReset - both signals change atomically
        const patchState = { dtr: false, rts: false };
        Transport.prototype.setDTR = async function(state) {
            patchState.dtr = state;
            this._DTR_state = state;
            // Don't send - setRTS will send both
        };
        Transport.prototype.setRTS = async function(state) {
            patchState.rts = state;
            // Send both signals atomically
            await this.device.setSignals({
                dataTerminalReady: patchState.dtr,
                requestToSend: patchState.rts
            });
        };

        const SERVER = 'https://power-monitor.club';
        let currentDeviceId = '';
        let flashedDeviceId = null; // Device ID from ESP32 after flashing
        let cachedOwnerEmail = null;
        let flashSuccess = false;

        // State for flashing
        let device = null;
        let transport = null;
        let esploader = null;

        // Elements
        const deviceNameInput = document.getElementById('deviceName');
        const flashBtn = document.getElementById('flashBtn');
        const flashBtnText = document.getElementById('flashBtnText');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const flashLog = document.getElementById('flashLog');
        const wifiBtnInner = document.getElementById('wifiBtnInner');
        const wifiStatus = document.getElementById('wifiStatus');
        const browserWarning = document.getElementById('browserWarning');

        // Check browser support
        if (!navigator.serial) {
            browserWarning.classList.add('visible');
        }

        // Get owner email (cached)
        fetch('/api/me', { credentials: 'include' }).then(r => r.ok ? r.json() : null).then(data => {
            cachedOwnerEmail = data?.email || null;
            console.log('Logged in as:', cachedOwnerEmail || 'not logged in');
        }).catch(e => console.error('Auth check failed:', e));

        // Generate device ID from name
        function generateId(name) {
            const slug = name.toLowerCase()
                .replace(/[–∞-—è—ñ—ó—î“ë]/g, c => {
                    const map = {'–∞':'a','–±':'b','–≤':'v','–≥':'h','“ë':'g','–¥':'d','–µ':'e','—î':'ye','–∂':'zh','–∑':'z','–∏':'y','—ñ':'i','—ó':'yi','–π':'y','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'kh','—Ü':'ts','—á':'ch','—à':'sh','—â':'shch','—å':'','—é':'yu','—è':'ya'};
                    return map[c] || c;
                })
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_|_$/g, '')
                .substring(0, 20);
            return slug + '_' + Math.random().toString(36).substring(2, 6);
        }

        // Logging
        function log(msg, type = '') {
            flashLog.classList.add('visible');
            const line = document.createElement('div');
            if (type) line.className = type;
            line.textContent = msg;
            flashLog.appendChild(line);
            flashLog.scrollTop = flashLog.scrollHeight;
        }

        function setProgress(pct, text) {
            progressContainer.classList.add('visible');
            progressFill.style.width = pct + '%';
            progressText.textContent = text;
        }

        // Terminal for esptool
        const espLoaderTerminal = {
            clean() { flashLog.innerHTML = ''; },
            writeLine(data) {
                if (data instanceof Uint8Array) data = new TextDecoder().decode(data);
                log(String(data));
            },
            write(data) {
                if (data instanceof Uint8Array) data = new TextDecoder().decode(data);
                log(String(data));
            }
        };

        // Cleanup
        function cleanUp() {
            device = null;
            transport = null;
            esploader = null;
        }

        // UI update
        function updateUI() {
            const name = deviceNameInput.value.trim();
            if (name.length >= 3) {
                flashBtn.disabled = false;
                currentDeviceId = generateId(name);
                document.getElementById('step1').classList.add('active');
            } else {
                flashBtn.disabled = true;
                currentDeviceId = '';
                document.getElementById('step1').classList.remove('active');
            }

            // Enable WiFi button only after successful flash
            // wifiBtnInner.disabled = !flashSuccess; // TEMP: disabled for testing
        }

        // Bind input event
        deviceNameInput.addEventListener('input', updateUI);

        // Flash button click - direct flashing
        flashBtn.onclick = async () => {
            const name = deviceNameInput.value.trim();
            if (name.length < 3) return;

            if (!navigator.serial) {
                alert("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î Web Serial. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π Chrome –∞–±–æ Edge.");
                return;
            }

            flashBtn.disabled = true;
            flashBtnText.textContent = "–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...";
            flashBtn.classList.add('flashing');
            document.getElementById('step2').classList.add('active');

            try {
                // 1. Request port
                log("–í–∏–±–µ—Ä–∏ COM –ø–æ—Ä—Ç...");
                device = await navigator.serial.requestPort({});
                const deviceInfo = device.getInfo();
                log("Port: VID=0x" + deviceInfo.usbVendorId?.toString(16) + " PID=0x" + deviceInfo.usbProductId?.toString(16));

                // 2. Create transport (patched to set DTR+RTS simultaneously)
                log("–°—Ç–≤–æ—Ä–µ–Ω–Ω—è transport...");
                transport = new Transport(device, true);

                // 4. Create loader
                log("–°—Ç–≤–æ—Ä–µ–Ω–Ω—è ESPLoader...");
                esploader = new ESPLoader({
                    transport,
                    baudrate: 115200,  // Keep same as ROM baudrate - CP2102 unstable at higher speeds
                    terminal: espLoaderTerminal,
                    debugLogging: false
                });

                // 5. Connect to chip (Transport patched for simultaneous DTR+RTS)
                setProgress(10, "–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ ESP32...");
                log("–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —á—ñ–ø–∞...");
                const chip = await esploader.main();
                log("–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ: " + chip, "success");

                // 5. Download firmware
                setProgress(15, "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—à–∏–≤–∫–∏...");
                flashBtnText.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
                log("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—à–∏–≤–∫–∏...");

                const fwUrl = `${SERVER}/api/firmware?device=${currentDeviceId}&name=${encodeURIComponent(name)}&server=178.62.112.232&improv=true`;
                const resp = await fetch(fwUrl);
                if (!resp.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: " + resp.status);

                const fwData = new Uint8Array(await resp.arrayBuffer());
                log("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ " + fwData.length + " –±–∞–π—Ç", "success");

                // 6. Flash firmware + erase NVS
                setProgress(20, "–ü—Ä–æ—à–∏–≤–∫–∞...");
                flashBtnText.textContent = "–ü—Ä–æ—à–∏–≤–∫–∞...";
                log("–û—á–∏—â–µ–Ω–Ω—è NVS —Ç–∞ –ø—Ä–æ—à–∏–≤–∫–∞...");
                const startTime = Date.now();

                // Create blank NVS region (0xFF = erased flash)
                const NVS_ADDR = 0x9000;
                const NVS_SIZE = 0x5000; // 20KB
                const blankNvs = new Uint8Array(NVS_SIZE).fill(0xFF);

                await esploader.writeFlash({
                    fileArray: [
                        { data: blankNvs, address: NVS_ADDR },  // Erase NVS first
                        { data: fwData, address: 0 }            // Then flash firmware
                    ],
                    flashSize: 'keep',
                    flashMode: 'keep',
                    flashFreq: 'keep',
                    eraseAll: false,
                    compress: true,
                    reportProgress: (fileIndex, written, total) => {
                        const pct = Math.round(20 + (written / total * 75));
                        setProgress(pct, `–ü—Ä–æ—à–∏–≤–∫–∞: ${Math.round(written / total * 100)}%`);
                    }
                });

                const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                log("–ü—Ä–æ—à–∏–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ " + totalTime + " —Å–µ–∫!", "success");

                // 7. Hard reset (use device directly, not patched transport)
                setProgress(98, "–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");
                log("Hard reset...");
                await device.setSignals({ dataTerminalReady: false, requestToSend: true }); // EN=LOW
                await new Promise(r => setTimeout(r, 100));
                await device.setSignals({ dataTerminalReady: false, requestToSend: false }); // EN=HIGH

                // 8. Disconnect transport and close port
                const flashPort = device; // Save reference before cleanUp
                await transport.disconnect();
                cleanUp();

                // Explicitly close port before reopening
                try { await flashPort.close(); } catch(e) {}

                // Success - but wait for ESP32 to boot before enabling WiFi
                setProgress(100, "–ì–æ—Ç–æ–≤–æ! –û—á—ñ–∫—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");
                log("–ü—Ä–æ—à–∏–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—á—ñ–∫—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ESP32...", "success");

                // Wait for ESP32 to boot (3s delay in firmware + boot time)
                await new Promise(r => setTimeout(r, 7000));

                log("–û—Ç—Ä–∏–º—É—î–º–æ ID –ø—Ä–∏—Å—Ç—Ä–æ—é...");
                flashSuccess = true;

                // Get real device ID from ESP32 via Improv (reuse flashing port)
                let realDeviceId = null;
                try {
                    // Reopen the same port for Improv
                    improvPort = flashPort;
                    await improvPort.open({ baudRate: 115200 });

                    // Keep DTR=false to avoid ESP32 reset
                    await improvPort.setSignals({ dataTerminalReady: false, requestToSend: false });

                    improvReader = improvPort.readable.getReader();
                    improvWriter = improvPort.writable.getWriter();
                    improvBuffer = [];

                    // Start background reading
                    improvReading = true;
                    improvReaderId++;
                    const myReaderId = improvReaderId;
                    (async () => {
                        while (improvReading && improvReaderId === myReaderId) {
                            try {
                                const { value, done } = await improvReader.read();
                                if (done || improvReaderId !== myReaderId) break;
                                if (value) improvBuffer.push(...value);
                            } catch (e) { break; }
                        }
                    })();

                    // Wait and drain boot messages
                    await new Promise(r => setTimeout(r, 1500));
                    improvBuffer = []; // Clear boot messages

                    // Send GET_DEVICE_INFO (RPC command 0x03) with retry
                    let response = null;
                    for (let attempt = 0; attempt < 3 && !response; attempt++) {
                        if (attempt > 0) {
                            log("–ü–æ–≤—Ç–æ—Ä–Ω–∞ —Å–ø—Ä–æ–±–∞ Improv...");
                            await new Promise(r => setTimeout(r, 1000));
                        }
                        await improvSend(0x03, [0x03, 0x00]);
                        response = await improvReadPacket(3000);
                    }
                    if (response && response.type === 0x04) {
                        // Parse: [cmd_id, total_len, str1_len, str1..., str2_len, str2..., ...]
                        // str4 is deviceName which now contains device ID
                        const data = response.data;
                        let pos = 2; // skip cmd_id and total_len
                        const strings = [];
                        while (pos < data.length && strings.length < 4) {
                            const len = data[pos];
                            if (pos + 1 + len > data.length) break;
                            strings.push(new TextDecoder().decode(new Uint8Array(data.slice(pos + 1, pos + 1 + len))));
                            pos += 1 + len;
                        }
                        if (strings.length >= 4) {
                            realDeviceId = strings[3]; // deviceName = device ID
                            flashedDeviceId = realDeviceId; // Save globally for Telegram setup
                            log("ID –ø—Ä–∏—Å—Ç—Ä–æ—é: " + realDeviceId, "success");
                        }
                    }

                    // Close Improv connection (will reopen for WiFi)
                    improvReading = false;
                    try { improvReader.releaseLock(); } catch(e) {}
                    try { improvWriter.releaseLock(); } catch(e) {}
                    try { await improvPort.close(); } catch(e) {}
                    improvPort = null;
                    improvReader = null;
                    improvWriter = null;
                } catch (e) {
                    console.error('Get device ID error:', e);
                }

                // Save device to user profile
                if (realDeviceId) {
                    try {
                        const claimUrl = '/api/claim?device=' + encodeURIComponent(realDeviceId) +
                            '&name=' + encodeURIComponent(name);
                        const claimRes = await fetch(claimUrl);
                        if (claimRes.ok) {
                            log("–ü—Ä–∏—Å—Ç—Ä—ñ–π –¥–æ–¥–∞–Ω–æ –¥–æ –ø—Ä–æ—Ñ—ñ–ª—é!", "success");
                        } else if (claimRes.status === 401) {
                            log("–£–≤—ñ–π–¥—ñ—Ç—å –≤ –∞–∫–∞—É–Ω—Ç —â–æ–± –∑–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–∏—Å—Ç—Ä—ñ–π", "error");
                        } else {
                            console.log('Claim failed:', claimRes.status);
                        }
                    } catch (e) {
                        console.error('Claim error:', e);
                    }
                }

                log("–ì–æ—Ç–æ–≤–æ! –ù–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è WiFi.", "success");
                wifiBtnInner.disabled = false;

                // Highlight WiFi button and scroll to it
                document.getElementById('step3').classList.add('active');
                wifiBtnInner.classList.add('pulse-attention');
                wifiBtnInner.scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.getElementById('step2num').textContent = '‚úì';
                document.getElementById('step2num').classList.add('done');
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step2').classList.add('completed');
                document.getElementById('step3').classList.add('active');
                flashBtnText.textContent = "–ü—Ä–æ—à–∏—Ç–æ ‚úì";
                flashBtn.classList.remove('flashing');

                // Enable Telegram setup button
                document.getElementById('telegramBtnInner').disabled = false;

            } catch (e) {
                log("–ü–æ–º–∏–ª–∫–∞: " + e.message, "error");
                console.error(e);

                // Cleanup on error
                if (transport) {
                    try { await transport.disconnect(); } catch(err) { console.error(err); }
                }
                if (device) {
                    try { await device.close(); } catch(err) { console.error(err); }
                    try { await device.forget(); } catch(err) {}
                }
                cleanUp();

                flashBtn.disabled = false;
                flashBtnText.textContent = "–ü—Ä–æ—à–∏—Ç–∏ ESP32";
                flashBtn.classList.remove('flashing');
                document.getElementById('step2').classList.remove('active');
                setProgress(0, "–ü–æ–º–∏–ª–∫–∞");
            }
        };

        // Custom Improv WiFi implementation
        const wifiDialog = document.getElementById('wifiDialog');
        const wifiNetworkList = document.getElementById('wifiNetworkList');
        const wifiSsid = document.getElementById('wifiSsid');
        const wifiPass = document.getElementById('wifiPass');
        const wifiSaveBtn = document.getElementById('wifiSave');
        const wifiTestBtn = document.getElementById('wifiTest');
        const wifiCloseBtn = document.getElementById('wifiClose');
        const wifiLogEl = document.getElementById('wifiLog');

        let improvPort = null;
        let improvReader = null;
        let improvWriter = null;
        let improvBuffer = [];
        let improvReading = false;
        let improvReaderId = 0;

        function wifiLog(msg, type = '') {
            wifiLogEl.classList.add('visible');
            const line = document.createElement('div');
            if (type) line.className = type;
            line.textContent = msg;
            wifiLogEl.appendChild(line);
            wifiLogEl.scrollTop = wifiLogEl.scrollHeight;
        }

        // Improv protocol helpers
        function buildImprovPacket(type, data) {
            const header = [0x49, 0x4D, 0x50, 0x52, 0x4F, 0x56]; // "IMPROV"
            const version = 0x01;
            const packet = [...header, version, type, data.length, ...data];
            // Checksum = sum of ALL bytes (including IMPROV header) - ImprovWiFiLibrary quirk
            const checksum = packet.reduce((a, b) => a + b, 0) & 0xFF;
            return new Uint8Array([...packet, checksum]);  // No trailing newline!
        }

        async function improvSend(type, data = []) {
            const packet = buildImprovPacket(type, data);
            await improvWriter.write(packet);
        }

        // Parse one packet from buffer, returns null if not enough data
        function parsePacketFromBuffer() {
            while (improvBuffer.length >= 10) {
                const headerIdx = improvBuffer.findIndex((v, i) =>
                    i <= improvBuffer.length - 6 &&
                    improvBuffer[i] === 0x49 && improvBuffer[i+1] === 0x4D &&
                    improvBuffer[i+2] === 0x50 && improvBuffer[i+3] === 0x52 &&
                    improvBuffer[i+4] === 0x4F && improvBuffer[i+5] === 0x56
                );

                if (headerIdx === -1) {
                    improvBuffer = improvBuffer.slice(-5);
                    return null;
                }

                if (headerIdx > 0) improvBuffer = improvBuffer.slice(headerIdx);
                if (improvBuffer.length < 10) return null;

                const dataLen = improvBuffer[8];
                const packetLen = 9 + dataLen + 1;

                if (improvBuffer.length < packetLen) return null;

                const packet = improvBuffer.slice(0, packetLen);
                improvBuffer = improvBuffer.slice(packetLen);

                return {
                    type: packet[7],
                    data: packet.slice(9, 9 + dataLen)
                };
            }
            return null;
        }

        // Background read loop
        async function startImprovReading() {
            const myId = ++improvReaderId;
            improvReading = true;

            try {
                while (improvReading && improvReader && improvReaderId === myId) {
                    const { value, done } = await improvReader.read();
                    if (done) break;
                    if (value && value.length > 0) {
                        console.log('Reader got', value.length, 'bytes:', Array.from(value.slice(0, 20)).map(b => b.toString(16).padStart(2, '0')).join(' '));
                        improvBuffer.push(...value);
                    }
                }
            } catch (e) {
                console.log('Reader error:', e);
                // Reader closed or replaced
            }
            if (improvReaderId === myId) {
                improvReading = false;
            }
        }

        async function improvReadPacket(timeout = 5000) {
            const startTime = Date.now();

            while (Date.now() - startTime < timeout) {
                const packet = parsePacketFromBuffer();
                if (packet) return packet;
                await new Promise(r => setTimeout(r, 50)); // Small delay
            }
            return null;
        }

        async function improvConnect() {
            try {
                improvPort = await navigator.serial.requestPort();
                await improvPort.open({ baudRate: 115200 });

                // Don't set DTR=true - it causes ESP32 reset on some boards
                await improvPort.setSignals({ dataTerminalReady: false, requestToSend: false });

                improvReader = improvPort.readable.getReader();
                improvWriter = improvPort.writable.getWriter();
                improvBuffer = [];

                // Start background reading
                startImprovReading();

                wifiLog('–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ –ø–æ—Ä—Ç—É');

                // Wait for any boot messages to pass, then clear buffer
                // Don't send GET_CURRENT_STATE - ImprovWiFiLibrary bug prevents
                // subsequent commands from working after first response
                await new Promise(r => setTimeout(r, 1000));
                improvBuffer = [];

                return true;

            } catch (e) {
                wifiLog('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
                return false;
            }
        }

        async function improvSendWifi(ssid, password) {
            try {
                wifiLog(`–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ "${ssid}"...`);

                // Build WiFi credentials packet (RPC command format)
                const ssidBytes = new TextEncoder().encode(ssid);
                const passBytes = new TextEncoder().encode(password);
                const totalLen = 1 + ssidBytes.length + 1 + passBytes.length;
                const data = [0x01, totalLen, ssidBytes.length, ...ssidBytes, passBytes.length, ...passBytes];

                await improvSend(0x03, data); // RPC command

                // Wait for response - ESP32 tries to connect for ~10 seconds
                const startTime = Date.now();

                while (Date.now() - startTime < 20000) {
                    // Long timeout - ESP32 needs time to try connecting
                    const response = await improvReadPacket(12000);
                    if (!response) {
                        continue;
                    }

                    if (response.type === 0x01) { // CURRENT_STATE
                        const state = response.data[0];
                        if (state === 0x03) { // PROVISIONING
                            wifiLog('–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...');
                        } else if (state === 0x04) { // PROVISIONED
                            wifiLog('–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ! –ß–µ–∫–∞—î–º–æ URL...');
                            // Don't return yet - wait for RPC_RESULT with URL
                            continue;
                        } else if (state === 0x00) { // STOPPED - connection failed
                            // Wait for ERROR_STATE with details
                            continue;
                        }
                    } else if (response.type === 0x04) { // RPC_RESULT - success
                        wifiLog('WiFi –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ!', 'success');
                        return true;
                    } else if (response.type === 0x02) { // ERROR_STATE
                        const errCode = response.data[0];
                        if (errCode === 0) continue; // ERROR_NONE - ignore, wait for PROVISIONED
                        const errors = {1: 'Invalid RPC', 2: 'Unknown RPC', 3: '–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å –∞–±–æ –º–µ—Ä–µ–∂–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 4: 'Not authorized'};
                        throw new Error(errors[errCode] || `Error ${errCode}`);
                    }
                }

                throw new Error('–¢–∞–π–º–∞—É—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è');

            } catch (e) {
                wifiLog('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
                return false;
            }
        }

        // Save WiFi credentials without waiting for connection result
        async function improvSendWifiSaveOnly(ssid, password) {
            try {
                wifiLog(`–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è "${ssid}"...`);

                const ssidBytes = new TextEncoder().encode(ssid);
                const passBytes = new TextEncoder().encode(password);
                const totalLen = 1 + ssidBytes.length + 1 + passBytes.length;
                const data = [0x01, totalLen, ssidBytes.length, ...ssidBytes, passBytes.length, ...passBytes];

                await improvSend(0x03, data);

                // Just wait a moment for ESP32 to save
                await new Promise(r => setTimeout(r, 500));
                wifiLog('–ó–±–µ—Ä–µ–∂–µ–Ω–æ! –ü—Ä–∏—Å—Ç—Ä—ñ–π —Å–ø—Ä–æ–±—É—î –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—å –ø—Ä–∏ –Ω–∞—Å—Ç—É–ø–Ω–æ–º—É –∑–∞–ø—É—Å–∫—É.', 'success');
                return true;

            } catch (e) {
                wifiLog('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
                return false;
            }
        }

        async function improvDisconnect() {
            improvReading = false;
            try {
                if (improvReader) { improvReader.releaseLock(); improvReader = null; }
                if (improvWriter) { improvWriter.releaseLock(); improvWriter = null; }
                if (improvPort) { await improvPort.close(); improvPort = null; }
            } catch (e) {}
        }

        // WiFi button click
        wifiBtnInner.onclick = async () => {
            wifiLogEl.innerHTML = '';
            wifiLogEl.classList.remove('visible');
            wifiNetworkList.innerHTML = '<div class="wifi-network-empty">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</div>';
            wifiSsid.value = '';
            wifiPass.value = '';
            wifiDialog.style.display = 'flex';

            if (await improvConnect()) {
                // Auto-scan networks
                await improvScanNetworks();
            }
        };

        // Save button - saves credentials without waiting for connection
        wifiSaveBtn.onclick = async () => {
            const ssid = wifiSsid.value.trim();
            const pass = wifiPass.value;

            if (!ssid) {
                wifiLog('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º–µ—Ä–µ–∂—ñ', 'error');
                return;
            }
            if (pass && pass.length < 8) {
                wifiLog('–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 8 —Å–∏–º–≤–æ–ª—ñ–≤', 'error');
                return;
            }

            wifiSaveBtn.disabled = true;
            wifiTestBtn.disabled = true;

            // Send credentials (ESP32 saves them immediately)
            await improvSendWifiSaveOnly(ssid, pass);

            wifiSaveBtn.disabled = false;
            wifiTestBtn.disabled = false;
        };

        // Test button - saves and waits for connection result
        wifiTestBtn.onclick = async () => {
            const ssid = wifiSsid.value.trim();
            const pass = wifiPass.value;

            if (!ssid) {
                wifiLog('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –º–µ—Ä–µ–∂—ñ', 'error');
                return;
            }
            if (pass && pass.length < 8) {
                wifiLog('–ü–∞—Ä–æ–ª—å –º–∞—î –±—É—Ç–∏ –º—ñ–Ω—ñ–º—É–º 8 —Å–∏–º–≤–æ–ª—ñ–≤', 'error');
                return;
            }

            wifiSaveBtn.disabled = true;
            wifiTestBtn.disabled = true;

            if (await improvSendWifi(ssid, pass)) {
                wifiLog('–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ! –ü—Ä–∏—Å—Ç—Ä—ñ–π –ø–æ—á–Ω–µ –ø—ñ–Ω–≥—É–≤–∞—Ç–∏ —Å–µ—Ä–≤–µ—Ä.', 'success');

                // Update UI
                wifiStatus.textContent = 'WiFi –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ!';
                wifiStatus.classList.add('visible');
                document.getElementById('step3num').textContent = '‚úì';
                document.getElementById('step3num').classList.add('done');
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step3').classList.add('completed');

                setTimeout(() => {
                    wifiDialog.style.display = 'none';
                    improvDisconnect();
                }, 2000);
            }

            wifiSaveBtn.disabled = false;
            wifiTestBtn.disabled = false;
        };

        // Close button
        wifiCloseBtn.onclick = async () => {
            wifiDialog.style.display = 'none';
            await improvDisconnect();
        };

        // WiFi scan - RPC command 0x04
        async function improvScanNetworks() {
            wifiLog('–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è –º–µ—Ä–µ–∂...');
            wifiNetworkList.innerHTML = '<div class="wifi-network-empty">–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è...</div>';

            try {
                // Wait a bit before scan (ESP32 needs time between commands)
                await new Promise(r => setTimeout(r, 500));
                improvBuffer = [];

                // Send SCAN_WIFI command (RPC command 0x04, data_length 0)
                const scanPacket = buildImprovPacket(0x03, [0x04, 0x00]);
                console.log('Sending WiFi scan packet:', Array.from(scanPacket).map(b => b.toString(16).padStart(2, '0')).join(' '));
                await improvWriter.write(scanPacket);

                // Wait for scan results - may come as multiple packets
                const networks = [];
                const startTime = Date.now();
                let gotResults = false;

                while (Date.now() - startTime < 15000) {
                    const response = await improvReadPacket(gotResults ? 2000 : 10000);
                    console.log('Scan response:', response, 'buffer:', improvBuffer.length);
                    if (!response) {
                        if (gotResults) break;
                        continue;
                    }

                    if (response.type === 0x04) { // RPC_RESULT
                        gotResults = true;
                        const data = response.data;

                        // Check for end marker (empty response or just command_id + 0 length)
                        if (data.length <= 2 || (data.length > 1 && data[1] === 0)) {
                            break; // End of scan results
                        }

                        // Each packet contains ONE network
                        // Format: [command_id, total_length, ssid_len, ssid, rssi_len, rssi, auth_len, auth]
                        let offset = 2; // Skip command ID and total_length

                        // Read SSID
                        if (offset >= data.length) continue;
                        const ssidLen = data[offset++];
                        if (offset + ssidLen > data.length) continue;
                        const ssid = new TextDecoder().decode(new Uint8Array(data.slice(offset, offset + ssidLen)));
                        offset += ssidLen;

                        // Read RSSI (sent as 1 byte, signed value)
                        if (offset >= data.length) continue;
                        const rssiLen = data[offset++];
                        if (offset + rssiLen > data.length) continue;
                        let rssi = 0;
                        if (rssiLen === 1) {
                            rssi = data[offset] > 127 ? data[offset] - 256 : data[offset];
                        } else {
                            rssi = parseInt(new TextDecoder().decode(new Uint8Array(data.slice(offset, offset + rssiLen)))) || 0;
                        }
                        offset += rssiLen;

                        // Read auth required
                        if (offset >= data.length) continue;
                        const authLen = data[offset++];
                        if (offset + authLen > data.length) continue;
                        const auth = new TextDecoder().decode(new Uint8Array(data.slice(offset, offset + authLen)));

                        if (ssid) {
                            networks.push({ ssid, rssi, auth: auth === 'YES' });
                        }
                    } else if (response.type === 0x02) { // ERROR_STATE
                        const errCode = response.data[0];
                        throw new Error(`Scan error: ${errCode}`);
                    }
                }

                // Remove duplicates (by SSID), keep strongest signal
                const uniqueNetworks = [];
                const seen = new Set();
                networks.sort((a, b) => b.rssi - a.rssi);
                for (const net of networks) {
                    if (!seen.has(net.ssid)) {
                        seen.add(net.ssid);
                        uniqueNetworks.push(net);
                    }
                }

                // Populate network list
                wifiNetworkList.innerHTML = '';
                if (uniqueNetworks.length > 0) {
                    uniqueNetworks.forEach(net => {
                        // Signal bars: 4 bars based on RSSI
                        const bars = net.rssi > -50 ? 4 : net.rssi > -60 ? 3 : net.rssi > -70 ? 2 : 1;
                        const signalBars = [1,2,3,4].map(i =>
                            `<div class="wifi-signal-bar ${i <= bars ? 'active' : ''}"></div>`
                        ).join('');

                        const item = document.createElement('div');
                        item.className = 'wifi-network-item';
                        item.dataset.ssid = net.ssid;
                        item.innerHTML = `
                            <span class="wifi-network-name">${net.ssid}</span>
                            <span class="wifi-network-info">
                                <span class="wifi-signal">${signalBars}</span>
                                ${net.auth ? 'üîí' : ''}
                            </span>
                        `;
                        item.onclick = () => selectNetwork(item, net.ssid);
                        wifiNetworkList.appendChild(item);
                    });
                    wifiLog(`–ó–Ω–∞–π–¥–µ–Ω–æ ${uniqueNetworks.length} –º–µ—Ä–µ–∂`, 'success');
                } else {
                    wifiNetworkList.innerHTML = '<div class="wifi-network-empty">–ú–µ—Ä–µ–∂—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
                    wifiLog('–ú–µ—Ä–µ–∂—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –í–≤–µ–¥—ñ—Ç—å SSID –≤—Ä—É—á–Ω—É.');
                }

            } catch (e) {
                wifiLog('–°–∫–∞–Ω—É–≤–∞–Ω–Ω—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ. –í–≤–µ–¥—ñ—Ç—å SSID –≤—Ä—É—á–Ω—É.', 'error');
                console.error('Scan error:', e);
                wifiNetworkList.innerHTML = '<div class="wifi-network-empty">–ü–æ–º–∏–ª–∫–∞ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è</div>';
            }
        }

        function selectNetwork(item, ssid) {
            // Remove selection from all items
            document.querySelectorAll('.wifi-network-item').forEach(el => el.classList.remove('selected'));
            // Select this item
            item.classList.add('selected');
            wifiSsid.value = ssid;
            wifiPass.focus();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', async () => {
            if (transport) {
                try { await transport.disconnect(); } catch(e) {}
            }
            await improvDisconnect();
        });

        // ===============================
        // Telegram Bot Setup
        // ===============================

        const telegramBtnInner = document.getElementById('telegramBtnInner');
        const telegramDialog = document.getElementById('telegramDialog');
        const telegramClose = document.getElementById('telegramClose');
        const telegramStatus = document.getElementById('telegramStatus');

        // Step elements
        const tgStep1 = document.getElementById('tgStep1');
        const tgStep2 = document.getElementById('tgStep2');
        const tgStep3 = document.getElementById('tgStep3');
        const tgStep1Ind = document.getElementById('tgStep1Ind');
        const tgStep2Ind = document.getElementById('tgStep2Ind');
        const tgStep3Ind = document.getElementById('tgStep3Ind');

        // Step 1 elements
        const tgBotToken = document.getElementById('tgBotToken');
        const tgVerifyToken = document.getElementById('tgVerifyToken');
        const tgTokenStatus = document.getElementById('tgTokenStatus');

        // Step 2 elements
        const tgBotInfo = document.getElementById('tgBotInfo');
        const tgBotName = document.getElementById('tgBotName');
        const tgBotUsername = document.getElementById('tgBotUsername');
        const tgFindChats = document.getElementById('tgFindChats');
        const tgChatList = document.getElementById('tgChatList');
        const tgStep2Status = document.getElementById('tgStep2Status');

        // Step 3 elements
        const tgSelectedChatName = document.getElementById('tgSelectedChatName');
        const tgSelectedChatId = document.getElementById('tgSelectedChatId');
        const tgSendTest = document.getElementById('tgSendTest');

        const tgLog = document.getElementById('tgLog');

        let currentBotToken = '';
        let currentBotInfo = null;
        let currentChatId = '';

        function tgLogMsg(msg, type = '') {
            tgLog.classList.add('visible');
            const line = document.createElement('div');
            if (type) line.style.color = type === 'error' ? 'var(--danger)' : 'var(--success)';
            line.textContent = msg;
            tgLog.appendChild(line);
            tgLog.scrollTop = tgLog.scrollHeight;
        }

        function setTgStatus(el, msg, type) {
            el.textContent = msg;
            el.className = 'tg-status ' + type;
        }

        function showTgStep(step) {
            tgStep1.style.display = step === 1 ? 'block' : 'none';
            tgStep2.style.display = step === 2 ? 'block' : 'none';
            tgStep3.style.display = step === 3 ? 'block' : 'none';

            tgStep1Ind.className = 'tg-step' + (step >= 1 ? ' active' : '') + (step > 1 ? ' done' : '');
            tgStep2Ind.className = 'tg-step' + (step >= 2 ? ' active' : '') + (step > 2 ? ' done' : '');
            tgStep3Ind.className = 'tg-step' + (step >= 3 ? ' active' : '') + (step > 3 ? ' done' : '');
        }

        // Open dialog
        telegramBtnInner.onclick = () => {
            telegramDialog.style.display = 'flex';
            tgLog.innerHTML = '';
            tgLog.classList.remove('visible');
            tgTokenStatus.className = 'tg-status';
            tgStep2Status.className = 'tg-status';
            showTgStep(1);
        };

        // Close dialog
        telegramClose.onclick = () => {
            telegramDialog.style.display = 'none';
        };

        // Step 1: Verify token
        tgVerifyToken.onclick = async () => {
            const token = tgBotToken.value.trim();
            if (!token) {
                setTgStatus(tgTokenStatus, '–í–≤–µ–¥—ñ—Ç—å —Ç–æ–∫–µ–Ω –±–æ—Ç–∞', 'error');
                return;
            }

            if (!token.match(/^\d+:[A-Za-z0-9_-]+$/)) {
                setTgStatus(tgTokenStatus, '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω—É', 'error');
                return;
            }

            tgVerifyToken.disabled = true;
            tgVerifyToken.textContent = '–ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ...';

            try {
                const res = await fetch(`https://api.telegram.org/bot${token}/getMe`);
                const data = await res.json();

                if (data.ok) {
                    currentBotToken = token;
                    currentBotInfo = data.result;

                    tgBotName.textContent = data.result.first_name;
                    tgBotUsername.textContent = '@' + data.result.username;

                    setTgStatus(tgTokenStatus, '–ë–æ—Ç –∑–Ω–∞–π–¥–µ–Ω–æ!', 'success');

                    setTimeout(() => {
                        showTgStep(2);
                    }, 500);
                } else {
                    setTgStatus(tgTokenStatus, '–¢–æ–∫–µ–Ω –Ω–µ–¥—ñ–π—Å–Ω–∏–π: ' + (data.description || '–Ω–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞'), 'error');
                }
            } catch (e) {
                setTgStatus(tgTokenStatus, '–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏: ' + e.message, 'error');
            }

            tgVerifyToken.disabled = false;
            tgVerifyToken.textContent = '–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ç–æ–∫–µ–Ω';
        };

        // Step 2: Find chats
        tgFindChats.onclick = async () => {
            tgFindChats.disabled = true;
            tgFindChats.innerHTML = '<span class="tg-btn-icon">‚è≥</span> –®—É–∫–∞—î–º–æ...';
            tgChatList.style.display = 'block';
            tgChatList.innerHTML = '<div class="tg-chat-empty">–®—É–∫–∞—î–º–æ —á–∞—Ç–∏...</div>';

            try {
                const res = await fetch(`https://api.telegram.org/bot${currentBotToken}/getUpdates?timeout=1`);
                const data = await res.json();

                if (!data.ok) {
                    throw new Error(data.description || '–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —á–∞—Ç—ñ–≤');
                }

                // Extract unique chats from updates
                const chats = new Map();
                for (const update of data.result) {
                    const msg = update.message || update.channel_post || update.my_chat_member?.chat;
                    if (msg && msg.chat) {
                        const chat = msg.chat;
                        if (!chats.has(chat.id)) {
                            chats.set(chat.id, {
                                id: chat.id,
                                title: chat.title || chat.first_name || chat.username || 'Chat',
                                type: chat.type,
                                username: chat.username
                            });
                        }
                    }
                }

                if (chats.size === 0) {
                    tgChatList.innerHTML = '<div class="tg-chat-empty">–ß–∞—Ç–∏ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.<br>–î–æ–¥–∞–π—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø—É –∞–±–æ –∫–∞–Ω–∞–ª —Ç–∞ –Ω–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è.</div>';
                    setTgStatus(tgStep2Status, '–î–æ–¥–∞–π—Ç–µ –±–æ—Ç–∞ –≤ —á–∞—Ç —ñ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –ø–æ—Ç—ñ–º –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–Ω–∞–π—Ç–∏ —á–∞—Ç–∏" —â–µ —Ä–∞–∑', 'error');
                } else {
                    tgChatList.innerHTML = '';
                    for (const [id, chat] of chats) {
                        const icon = chat.type === 'channel' ? 'üì¢' : chat.type === 'group' || chat.type === 'supergroup' ? 'üë•' : 'üí¨';
                        const typeLabel = chat.type === 'channel' ? '–ö–∞–Ω–∞–ª' : chat.type === 'group' || chat.type === 'supergroup' ? '–ì—Ä—É–ø–∞' : '–û—Å–æ–±–∏—Å—Ç–∏–π';

                        const item = document.createElement('div');
                        item.className = 'tg-chat-item';
                        item.innerHTML = `
                            <div class="tg-chat-icon">${icon}</div>
                            <div class="tg-chat-info">
                                <div class="tg-chat-name">${escapeHtml(chat.title)}</div>
                                <div class="tg-chat-type">${typeLabel}${chat.username ? ' ‚Ä¢ @' + chat.username : ''}</div>
                            </div>
                        `;
                        item.onclick = () => selectChat(chat);
                        tgChatList.appendChild(item);
                    }
                    tgStep2Status.className = 'tg-status';
                }

            } catch (e) {
                tgChatList.innerHTML = '<div class="tg-chat-empty">–ü–æ–º–∏–ª–∫–∞: ' + e.message + '</div>';
                setTgStatus(tgStep2Status, e.message, 'error');
            }

            tgFindChats.disabled = false;
            tgFindChats.innerHTML = '<span class="tg-btn-icon">üîç</span> –ó–Ω–∞–π—Ç–∏ —á–∞—Ç–∏';
        };

        async function selectChat(chat) {
            currentChatId = chat.id.toString();

            // Save to server
            try {
                const deviceId = flashedDeviceId || currentDeviceId || getDeviceIdFromPage();
                if (!deviceId) {
                    setTgStatus(tgStep2Status, '–°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ—à–∏–π—Ç–µ –ø—Ä–∏—Å—Ç—Ä—ñ–π', 'error');
                    return;
                }

                const res = await fetch(`/api/my-devices/${deviceId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        bot_token: currentBotToken,
                        chat_id: currentChatId
                    })
                });

                if (!res.ok) {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è: ' + res.status);
                }

                // Show success
                tgSelectedChatName.textContent = chat.title;
                tgSelectedChatId.textContent = 'ID: ' + chat.id;
                showTgStep(3);

                // Update main status
                telegramStatus.textContent = 'Telegram –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ: ' + chat.title;
                telegramStatus.className = 'telegram-status visible success';

                // Update step indicator
                document.getElementById('step4num').textContent = '‚úì';
                document.getElementById('step4num').classList.add('done');
                document.getElementById('step4').classList.add('completed');

            } catch (e) {
                setTgStatus(tgStep2Status, e.message, 'error');
            }
        }

        function getDeviceIdFromPage() {
            // Try to get from flashedDeviceId (from ESP32 MAC)
            if (flashedDeviceId) return flashedDeviceId;
            // Fallback to currentDeviceId if set
            if (currentDeviceId) return currentDeviceId;
            return null;
        }

        // Step 3: Send test message
        tgSendTest.onclick = async () => {
            tgSendTest.disabled = true;
            tgSendTest.innerHTML = '<span>‚è≥</span> –ù–∞–¥—Å–∏–ª–∞—î–º–æ...';

            try {
                const res = await fetch(`https://api.telegram.org/bot${currentBotToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        chat_id: currentChatId,
                        text: '‚úÖ Power Monitor –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ!\n\n–¢–µ–ø–µ—Ä –≤–∏ –±—É–¥–µ—Ç–µ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –≤–∫–ª—é—á–µ–Ω–Ω—è —Ç–∞ –≤–∏–∫–ª—é—á–µ–Ω–Ω—è —Å–≤—ñ—Ç–ª–∞.'
                    })
                });

                const data = await res.json();
                if (data.ok) {
                    tgSendTest.innerHTML = '<span>‚úì</span> –ù–∞–¥—ñ—Å–ª–∞–Ω–æ!';
                    tgSendTest.style.background = 'var(--success)';
                    tgSendTest.style.color = 'white';
                    tgSendTest.style.borderColor = 'var(--success)';
                } else {
                    throw new Error(data.description || '–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è');
                }
            } catch (e) {
                tgSendTest.innerHTML = '<span>‚ùå</span> ' + e.message;
                tgSendTest.style.borderColor = 'var(--danger)';
                tgSendTest.style.color = 'var(--danger)';
            }

            setTimeout(() => {
                tgSendTest.disabled = false;
                tgSendTest.innerHTML = '<span>üì§</span> –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ —Ç–µ—Å—Ç–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è';
                tgSendTest.style = '';
            }, 3000);
        };

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
