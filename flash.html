<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ü—Ä–æ—à–∏–≤–∫–∞ ESP32 ‚Äî Power Monitor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/improv-wifi-serial-sdk@2.5.0/dist/serial-launch-button.js?module"></script>

    <style>
        :root {
            --bg-void: #030305;
            --bg-surface: #0a0a0f;
            --bg-elevated: #111118;
            --bg-input: #08080c;
            --electric: #fbbf24;
            --electric-dim: #b8860b;
            --electric-glow: rgba(251, 191, 36, 0.25);
            --electric-subtle: rgba(251, 191, 36, 0.08);
            --success: #10b981;
            --success-glow: rgba(16, 185, 129, 0.25);
            --danger: #ef4444;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-tertiary: #52525b;
            --border: rgba(251, 191, 36, 0.12);
            --border-subtle: rgba(255,255,255,0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            background: var(--bg-void);
        }

        body {
            font-family: 'Outfit', system-ui, sans-serif;
            background: var(--bg-void);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
            overflow-x: hidden;
        }

        /* Circuit board pattern background */
        .circuit-bg {
            position: fixed;
            inset: 0;
            opacity: 0.4;
            pointer-events: none;
            background:
                linear-gradient(90deg, transparent 49.5%, var(--electric-subtle) 49.5%, var(--electric-subtle) 50.5%, transparent 50.5%),
                linear-gradient(0deg, transparent 49.5%, var(--electric-subtle) 49.5%, var(--electric-subtle) 50.5%, transparent 50.5%);
            background-size: 60px 60px;
            mask-image: radial-gradient(ellipse 80% 60% at 50% 0%, black 0%, transparent 70%);
        }

        /* Animated glow orb */
        .glow-orb {
            position: fixed;
            top: -200px;
            left: 50%;
            transform: translateX(-50%);
            width: 600px;
            height: 400px;
            background: radial-gradient(ellipse, var(--electric-glow) 0%, transparent 70%);
            pointer-events: none;
            animation: orb-pulse 4s ease-in-out infinite;
        }

        @keyframes orb-pulse {
            0%, 100% { opacity: 0.6; transform: translateX(-50%) scale(1); }
            50% { opacity: 0.9; transform: translateX(-50%) scale(1.1); }
        }

        /* Scanline effect */
        .scanlines {
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                transparent 0px,
                transparent 2px,
                rgba(0,0,0,0.1) 2px,
                rgba(0,0,0,0.1) 4px
            );
            z-index: 1000;
            opacity: 0.3;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 48px 24px 80px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 48px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 14px;
            text-decoration: none;
            color: var(--text-primary);
            margin-bottom: 32px;
            transition: transform 0.2s;
        }

        .logo:hover {
            transform: scale(1.02);
        }

        .logo-icon {
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--electric) 0%, var(--electric-dim) 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow:
                0 0 40px var(--electric-glow),
                inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 16px;
            border: 1px solid var(--electric);
            opacity: 0.3;
        }

        .logo-text {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 18px;
            letter-spacing: -0.5px;
        }

        .page-title {
            font-family: 'Space Mono', monospace;
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -1px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 400;
        }

        /* Browser warning */
        .browser-warning {
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 32px;
            text-align: center;
            font-size: 14px;
            display: none;
            backdrop-filter: blur(10px);
        }

        .browser-warning.visible {
            display: block;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Steps */
        .step {
            background: var(--bg-surface);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 28px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .step::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--electric), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .step:hover::before,
        .step.active::before {
            opacity: 0.5;
        }

        .step.completed {
            border-color: rgba(16, 185, 129, 0.3);
        }

        .step.completed::before {
            background: linear-gradient(90deg, transparent, var(--success), transparent);
            opacity: 0.5;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-elevated);
            border: 2px solid var(--electric);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            font-size: 14px;
            color: var(--electric);
            flex-shrink: 0;
            transition: all 0.3s;
        }

        .step-number.done {
            background: var(--success);
            border-color: var(--success);
            color: white;
            box-shadow: 0 0 20px var(--success-glow);
        }

        .step-title {
            font-family: 'Space Mono', monospace;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .step-desc {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* Input */
        .input-wrapper {
            position: relative;
        }

        .form-input {
            width: 100%;
            padding: 16px 20px;
            background: var(--bg-input);
            border: 2px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--electric);
            box-shadow: 0 0 0 4px var(--electric-subtle);
            background: var(--bg-surface);
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
            font-weight: 400;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 18px 28px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--electric) 0%, var(--electric-dim) 100%);
            color: var(--bg-void);
            box-shadow: 0 4px 20px var(--electric-glow);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .btn-primary:hover:not(:disabled)::before {
            opacity: 1;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 40px var(--electric-glow);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn.flashing {
            animation: btn-pulse 1.5s ease-in-out infinite;
        }

        @keyframes btn-pulse {
            0%, 100% { box-shadow: 0 4px 20px var(--electric-glow); }
            50% { box-shadow: 0 4px 40px var(--electric-glow), 0 0 60px var(--electric-glow); }
        }

        .btn-icon {
            font-size: 18px;
        }

        /* Progress */
        .progress-container {
            margin-top: 24px;
            display: none;
        }

        .progress-container.visible {
            display: block;
            animation: fade-in 0.3s ease;
        }

        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-bar {
            height: 6px;
            background: var(--bg-elevated);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 12px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--electric), var(--success));
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 3px;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 100px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3));
            animation: progress-shine 1.5s ease-in-out infinite;
        }

        @keyframes progress-shine {
            0% { transform: translateX(-100px); }
            100% { transform: translateX(400px); }
        }

        .progress-text {
            font-family: 'Space Mono', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Log */
        .flash-log {
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-void);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            font-family: 'Space Mono', monospace;
            font-size: 11px;
            max-height: 180px;
            overflow-y: auto;
            display: none;
            line-height: 1.7;
        }

        .flash-log.visible {
            display: block;
            animation: fade-in 0.3s ease;
        }

        .flash-log::-webkit-scrollbar {
            width: 6px;
        }

        .flash-log::-webkit-scrollbar-track {
            background: var(--bg-surface);
            border-radius: 3px;
        }

        .flash-log::-webkit-scrollbar-thumb {
            background: var(--text-tertiary);
            border-radius: 3px;
        }

        .flash-log div {
            color: var(--text-secondary);
        }

        .flash-log .error { color: var(--danger); }
        .flash-log .success { color: var(--success); }

        /* WiFi Section */
        .wifi-section {
            margin-top: 4px;
        }

        improv-wifi-serial-launch-button {
            --improv-primary-color: var(--success);
            --improv-on-primary-color: white;
        }

        .wifi-btn {
            width: 100%;
            padding: 18px 28px;
            border: none;
            border-radius: 14px;
            font-size: 15px;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            cursor: pointer;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.2s;
            box-shadow: 0 4px 20px var(--success-glow);
        }

        .wifi-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 40px var(--success-glow);
        }

        .wifi-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            box-shadow: none;
        }

        .wifi-btn.pulse-attention {
            animation: attention-pulse 1s ease-in-out infinite;
        }

        @keyframes attention-pulse {
            0%, 100% {
                box-shadow: 0 4px 20px var(--success-glow);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 4px 40px var(--success-glow), 0 0 60px var(--success-glow);
                transform: scale(1.02);
            }
        }

        .wifi-status {
            margin-top: 16px;
            padding: 14px 18px;
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 10px;
            font-size: 14px;
            display: none;
            color: var(--success);
        }

        .wifi-status.visible {
            display: block;
            animation: fade-in 0.3s ease;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
        }

        .footer-link {
            color: var(--text-tertiary);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .footer-link:hover {
            color: var(--electric);
        }

        /* Connection line between steps */
        .step-connector {
            width: 2px;
            height: 20px;
            background: var(--border-subtle);
            margin: 0 auto;
            position: relative;
        }

        .step-connector::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: var(--bg-surface);
            border: 2px solid var(--border-subtle);
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="circuit-bg"></div>
    <div class="glow-orb"></div>
    <div class="scanlines"></div>

    <div class="container">
        <div class="header">
            <a href="/" class="logo">
                <div class="logo-icon">‚ö°</div>
                <span class="logo-text">Power Monitor</span>
            </a>
            <h1 class="page-title">–ü—Ä–æ—à–∏–≤–∫–∞ ESP32</h1>
            <p class="page-subtitle">–í—Å—Ç–∞–Ω–æ–≤–∏ –ø—Ä–æ—à–∏–≤–∫—É —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–π WiFi</p>
        </div>

        <div class="browser-warning" id="browserWarning">
            ‚ö†Ô∏è –¶–µ–π –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î Web Serial. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π <strong>Chrome</strong> –∞–±–æ <strong>Edge</strong> –Ω–∞ –∫–æ–º–ø'—é—Ç–µ—Ä—ñ.
        </div>

        <!-- Step 1: Device Name -->
        <div class="step" id="step1">
            <div class="step-header">
                <div class="step-number" id="step1num">1</div>
                <div class="step-title">–ù–∞–∑–≤–∞ –ø—Ä–∏—Å—Ç—Ä–æ—é</div>
            </div>
            <div class="step-desc">–í–≤–µ–¥–∏ –Ω–∞–∑–≤—É –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó ‚Äî –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, ¬´–ö–≤–∞—Ä—Ç–∏—Ä–∞¬ª –∞–±–æ ¬´–î–∞—á–∞¬ª</div>
            <div class="input-wrapper">
                <input type="text" class="form-input" id="deviceName" placeholder="–í–≤–µ–¥–∏ –Ω–∞–∑–≤—É –ø—Ä–∏—Å—Ç—Ä–æ—é" maxlength="40" autocomplete="off" spellcheck="false">
            </div>
        </div>

        <div class="step-connector"></div>

        <!-- Step 2: Flash -->
        <div class="step" id="step2">
            <div class="step-header">
                <div class="step-number" id="step2num">2</div>
                <div class="step-title">–ü—Ä–æ—à–∏–≤–∫–∞</div>
            </div>
            <div class="step-desc">–ü—ñ–¥–∫–ª—é—á–∏ ESP32 –¥–æ USB —Ç–∞ –Ω–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É –ø—Ä–æ—à–∏–≤–∫–∏</div>

            <button class="btn btn-primary" id="flashBtn" disabled>
                <span class="btn-icon">‚ö°</span>
                <span id="flashBtnText">–ü—Ä–æ—à–∏—Ç–∏ ESP32</span>
            </button>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞...</div>
            </div>

            <div class="flash-log" id="flashLog"></div>
        </div>

        <div class="step-connector"></div>

        <!-- Step 3: WiFi -->
        <div class="step" id="step3">
            <div class="step-header">
                <div class="step-number" id="step3num">3</div>
                <div class="step-title">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è WiFi</div>
            </div>
            <div class="step-desc">–ü—ñ—Å–ª—è –ø—Ä–æ—à–∏–≤–∫–∏ –Ω–∞–ª–∞—à—Ç—É–π WiFi –º–µ—Ä–µ–∂—É –¥–ª—è –ø—Ä–∏—Å—Ç—Ä–æ—é</div>

            <div class="wifi-section">
                <improv-wifi-serial-launch-button id="wifiLauncher">
                    <button class="wifi-btn" id="wifiBtnInner" slot="activate" disabled>
                        <span>üì∂</span>
                        <span>–ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ WiFi</span>
                    </button>
                </improv-wifi-serial-launch-button>

                <div class="wifi-status" id="wifiStatus"></div>
            </div>
        </div>

        <div class="footer">
            <a href="/" class="footer-link">
                <span>‚Üê</span>
                <span>–ù–∞ –≥–æ–ª–æ–≤–Ω—É</span>
            </a>
        </div>
    </div>

    <script type="module">
        // Use local esptool-js bundle with flushInput fix
        import { ESPLoader, Transport } from '/esptool-bundle.js';

        const SERVER = 'https://power-monitor.club';
        let currentDeviceId = '';
        let cachedOwnerEmail = null;
        let flashSuccess = false;

        // State for flashing
        let device = null;
        let transport = null;
        let esploader = null;

        // Elements
        const deviceNameInput = document.getElementById('deviceName');
        const flashBtn = document.getElementById('flashBtn');
        const flashBtnText = document.getElementById('flashBtnText');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const flashLog = document.getElementById('flashLog');
        const wifiLauncher = document.getElementById('wifiLauncher');
        const wifiBtnInner = document.getElementById('wifiBtnInner');
        const wifiStatus = document.getElementById('wifiStatus');
        const browserWarning = document.getElementById('browserWarning');

        // Check browser support
        if (!navigator.serial) {
            browserWarning.classList.add('visible');
        }

        // Get owner email (cached)
        fetch('/api/me').then(r => r.ok ? r.json() : null).then(data => {
            cachedOwnerEmail = data?.email || null;
        }).catch(() => {});

        // Generate device ID from name
        function generateId(name) {
            const slug = name.toLowerCase()
                .replace(/[–∞-—è—ñ—ó—î“ë]/g, c => {
                    const map = {'–∞':'a','–±':'b','–≤':'v','–≥':'h','“ë':'g','–¥':'d','–µ':'e','—î':'ye','–∂':'zh','–∑':'z','–∏':'y','—ñ':'i','—ó':'yi','–π':'y','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'kh','—Ü':'ts','—á':'ch','—à':'sh','—â':'shch','—å':'','—é':'yu','—è':'ya'};
                    return map[c] || c;
                })
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_|_$/g, '')
                .substring(0, 20);
            return slug + '_' + Math.random().toString(36).substring(2, 6);
        }

        // Logging
        function log(msg, type = '') {
            flashLog.classList.add('visible');
            const line = document.createElement('div');
            if (type) line.className = type;
            line.textContent = msg;
            flashLog.appendChild(line);
            flashLog.scrollTop = flashLog.scrollHeight;
        }

        function setProgress(pct, text) {
            progressContainer.classList.add('visible');
            progressFill.style.width = pct + '%';
            progressText.textContent = text;
        }

        // Terminal for esptool
        const espLoaderTerminal = {
            clean() { flashLog.innerHTML = ''; },
            writeLine(data) { log(data); },
            write(data) { log(data); }
        };

        // Cleanup
        function cleanUp() {
            device = null;
            transport = null;
            esploader = null;
        }

        // UI update
        function updateUI() {
            const name = deviceNameInput.value.trim();
            if (name.length >= 3) {
                flashBtn.disabled = false;
                currentDeviceId = generateId(name);
                document.getElementById('step1').classList.add('active');
            } else {
                flashBtn.disabled = true;
                currentDeviceId = '';
                document.getElementById('step1').classList.remove('active');
            }

            // Enable WiFi button only after successful flash
            wifiBtnInner.disabled = !flashSuccess;
        }

        // Bind input event
        deviceNameInput.addEventListener('input', updateUI);

        // Flash button click - direct flashing
        flashBtn.onclick = async () => {
            const name = deviceNameInput.value.trim();
            if (name.length < 3) return;

            if (!navigator.serial) {
                alert("–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î Web Serial. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–π Chrome –∞–±–æ Edge.");
                return;
            }

            flashBtn.disabled = true;
            flashBtnText.textContent = "–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...";
            flashBtn.classList.add('flashing');
            document.getElementById('step2').classList.add('active');

            try {
                // 1. Request port
                log("–í–∏–±–µ—Ä–∏ COM –ø–æ—Ä—Ç...");
                device = await navigator.serial.requestPort({});
                const deviceInfo = device.getInfo();
                log("Port: VID=0x" + deviceInfo.usbVendorId?.toString(16) + " PID=0x" + deviceInfo.usbProductId?.toString(16));

                // 2. Create transport
                log("–°—Ç–≤–æ—Ä–µ–Ω–Ω—è transport...");
                transport = new Transport(device, true);

                // 3. Create loader
                log("–°—Ç–≤–æ—Ä–µ–Ω–Ω—è ESPLoader...");
                esploader = new ESPLoader({
                    transport,
                    baudrate: 460800,
                    terminal: espLoaderTerminal,
                    debugLogging: false
                });

                // 4. Connect to chip
                setProgress(5, "–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ ESP32...");
                log("–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —á—ñ–ø–∞...");
                const chip = await esploader.main();
                log("–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ: " + chip, "success");

                // 5. Download firmware
                setProgress(15, "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—à–∏–≤–∫–∏...");
                flashBtnText.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
                log("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—à–∏–≤–∫–∏...");

                const fwUrl = `${SERVER}/api/firmware?device=${currentDeviceId}&name=${encodeURIComponent(name)}&server=178.62.112.232&improv=true`;
                const resp = await fetch(fwUrl);
                if (!resp.ok) throw new Error("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è: " + resp.status);

                const fwData = new Uint8Array(await resp.arrayBuffer());
                log("–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ " + fwData.length + " –±–∞–π—Ç", "success");

                // Convert to binary string (esptool-js format)
                let binaryString = '';
                for (let i = 0; i < fwData.length; i++) {
                    binaryString += String.fromCharCode(fwData[i]);
                }

                // 6. Erase entire flash (including NVS with saved WiFi)
                setProgress(15, "–°—Ç–∏—Ä–∞–Ω–Ω—è flash...");
                flashBtnText.textContent = "–°—Ç–∏—Ä–∞–Ω–Ω—è...";
                log("–°—Ç–∏—Ä–∞–Ω–Ω—è flash (–≤–∫–ª—é—á–Ω–æ –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏)...");
                await esploader.eraseFlash();
                log("Flash —Å—Ç–µ—Ä—Ç–æ", "success");

                // 7. Flash
                setProgress(25, "–ü—Ä–æ—à–∏–≤–∫–∞...");
                flashBtnText.textContent = "–ü—Ä–æ—à–∏–≤–∫–∞...";
                log("–ü—Ä–æ—à–∏–≤–∫–∞...");
                const startTime = Date.now();

                await esploader.writeFlash({
                    fileArray: [{ data: binaryString, address: 0 }],
                    flashSize: 'keep',
                    flashMode: 'keep',
                    flashFreq: 'keep',
                    eraseAll: false,
                    compress: true,
                    reportProgress: (fileIndex, written, total) => {
                        const pct = Math.round(20 + (written / total * 75));
                        setProgress(pct, `–ü—Ä–æ—à–∏–≤–∫–∞: ${Math.round(written / total * 100)}%`);
                    }
                });

                const totalTime = ((Date.now() - startTime) / 1000).toFixed(1);
                log("–ü—Ä–æ—à–∏–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ " + totalTime + " —Å–µ–∫!", "success");

                // 8. Hard reset
                setProgress(98, "–ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");
                log("Hard reset...");
                await transport.setDTR(false);
                await transport.setRTS(true);
                await new Promise(r => setTimeout(r, 100));
                await transport.setRTS(false);

                // 9. Disconnect and release port completely
                await transport.disconnect();
                try { await device.close(); } catch(e) {}
                cleanUp();

                // Success - but wait for ESP32 to boot before enabling WiFi
                setProgress(100, "–ì–æ—Ç–æ–≤–æ! –û—á—ñ–∫—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");
                log("–ü—Ä–æ—à–∏–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—á—ñ–∫—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ESP32...", "success");

                // Wait for ESP32 to boot (3s delay in firmware + boot time)
                await new Promise(r => setTimeout(r, 5000));

                log("–ì–æ—Ç–æ–≤–æ! –ù–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è WiFi.", "success");
                flashSuccess = true;
                wifiBtnInner.disabled = false;

                // Highlight WiFi button and scroll to it
                document.getElementById('step3').classList.add('active');
                wifiBtnInner.classList.add('pulse-attention');
                wifiBtnInner.scrollIntoView({ behavior: 'smooth', block: 'center' });
                document.getElementById('step2num').textContent = '‚úì';
                document.getElementById('step2num').classList.add('done');
                document.getElementById('step2').classList.remove('active');
                document.getElementById('step2').classList.add('completed');
                document.getElementById('step3').classList.add('active');
                flashBtnText.textContent = "–ü—Ä–æ—à–∏—Ç–æ ‚úì";
                flashBtn.classList.remove('flashing');

            } catch (e) {
                log("–ü–æ–º–∏–ª–∫–∞: " + e.message, "error");
                console.error(e);

                // Cleanup on error
                if (transport) {
                    try { await transport.disconnect(); } catch(err) { console.error(err); }
                }
                if (device) {
                    try { await device.close(); } catch(err) { console.error(err); }
                }
                cleanUp();

                flashBtn.disabled = false;
                flashBtnText.textContent = "–ü—Ä–æ—à–∏—Ç–∏ ESP32";
                flashBtn.classList.remove('flashing');
                document.getElementById('step2').classList.remove('active');
                setProgress(0, "–ü–æ–º–∏–ª–∫–∞");
            }
        };

        // WiFi setup result
        wifiLauncher.addEventListener('closed', (event) => {
            const detail = event.detail || {};
            if (detail.success) {
                wifiStatus.textContent = "WiFi –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ! –ü—Ä–∏—Å—Ç—Ä—ñ–π –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ –º–µ—Ä–µ–∂—ñ.";
                wifiStatus.classList.add('visible');
                document.getElementById('step3num').textContent = '‚úì';
                document.getElementById('step3num').classList.add('done');
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step3').classList.add('completed');

                // Auto-claim device
                if (cachedOwnerEmail) {
                    fetch(`${SERVER}/api/claim`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ device_id: currentDeviceId })
                    }).catch(() => {});
                }
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', async () => {
            if (transport) {
                try { await transport.disconnect(); } catch(e) {}
            }
        });
    </script>
</body>
</html>
