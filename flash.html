<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>–ü—Ä–æ—à–∏–≤–∫–∞ ESP32 ‚Äî Power Monitor</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;800&family=Onest:wght@400;500;600&display=swap" rel="stylesheet">
    <script type="module" src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"></script>
    <script type="module" src="https://unpkg.com/improv-wifi-serial-sdk@2.5.0/dist/serial-launch-button.js?module"></script>
    <style>
        :root {
            --bg-deep: #06060a;
            --bg-card: #0d0d14;
            --bg-elevated: #13131c;
            --bg-input: #0a0a0f;
            --electric: #fbbf24;
            --electric-glow: rgba(251, 191, 36, 0.15);
            --online: #22c55e;
            --online-glow: rgba(34, 197, 94, 0.15);
            --text: #f4f4f5;
            --text-muted: #71717a;
            --text-dim: #3f3f46;
            --border: rgba(255,255,255,0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Onest', system-ui, sans-serif;
            background: var(--bg-deep);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.7' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            opacity: 0.03;
            pointer-events: none;
            z-index: 1000;
        }

        .grid-bg {
            position: fixed;
            inset: 0;
            background-image:
                linear-gradient(rgba(251,191,36,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(251,191,36,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 32px 20px 60px;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text);
            margin-bottom: 24px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--electric);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            box-shadow: 0 0 30px var(--electric-glow);
        }

        .logo-text {
            font-family: 'Unbounded', sans-serif;
            font-weight: 800;
            font-size: 20px;
        }

        .page-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-muted);
            font-size: 15px;
        }

        /* Steps */
        .step {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 16px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--electric);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Unbounded', sans-serif;
            font-weight: 800;
            font-size: 14px;
            color: var(--bg-deep);
        }

        .step-title {
            font-family: 'Unbounded', sans-serif;
            font-size: 16px;
            font-weight: 600;
        }

        .step-desc {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 16px;
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--electric);
            box-shadow: 0 0 0 3px var(--electric-glow);
        }

        .form-input::placeholder {
            color: var(--text-dim);
        }

        /* Flash button */
        .flash-section {
            text-align: center;
            padding: 32px 0;
        }

        .btn-flash {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 18px 32px;
            background: var(--online);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 17px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-flash:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }

        .btn-flash:disabled {
            background: var(--bg-elevated);
            color: var(--text-dim);
            cursor: not-allowed;
            transform: none;
        }

        esp-web-install-button {
            display: block;
        }

        /* Info box */
        .info-box {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        .info-box.success { border-color: rgba(34,197,94,0.5); }
        .info-box.error { border-color: rgba(239,68,68,0.5); }

        .info-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .info-text {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .info-text strong {
            color: var(--electric);
        }

        /* Feature list */
        .feature-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border-radius: 10px;
            font-size: 14px;
        }

        .feature-icon {
            font-size: 20px;
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 32px;
        }

        .footer-link {
            color: var(--text-dim);
            text-decoration: none;
            font-size: 14px;
        }

        .footer-link:hover {
            color: var(--electric);
        }

        @media (max-width: 500px) {
            .container {
                padding: 24px 16px 48px;
            }

            .page-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="grid-bg"></div>

    <div class="container">
        <div class="header">
            <a href="/" class="logo">
                <div class="logo-icon">‚ö°</div>
                <span class="logo-text">Power Monitor</span>
            </a>
            <h1 class="page-title">–ü—Ä–æ—à–∏–≤–∫–∞ ESP32</h1>
            <p class="page-subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è WiFi</p>
        </div>

        <!-- Step 1: Name device -->
        <div class="step">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">–ù–∞–∑–≤–∏ –ø—Ä–∏—Å—Ç—Ä—ñ–π</div>
            </div>
            <div class="form-group">
                <input type="text" class="form-input" id="deviceName"
                       placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ö–≤–∞—Ä—Ç–∏—Ä–∞ –Ω–∞ –•—Ä–µ—â–∞—Ç–∏–∫—É"
                       maxlength="40" oninput="updateFlashButton()">
            </div>
        </div>

        <!-- Step 2: Flash -->
        <div class="step">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">–ü—Ä–æ—à–∏–≤–∫–∞</div>
            </div>
            <p class="step-desc">
                –ü—ñ–¥–∫–ª—é—á–∏ ESP32 –¥–æ USB —ñ –Ω–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É. –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –ø—Ä–æ—à–∏–≤–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥—å –¥–æ –∫—Ä–æ–∫—É 3, —â–æ–± –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ WiFi.
            </p>

            <esp-web-install-button id="flashBtn">
                <button slot="activate" class="btn-flash" id="flashBtnInner" disabled>
                    ‚ö° –ü—Ä–æ—à–∏—Ç–∏ ESP32
                </button>
                <span slot="unsupported">–ü–æ—Ç—Ä—ñ–±–µ–Ω Chrome –∞–±–æ Edge</span>
                <span slot="not-allowed">–ù–∞—Ç–∏—Å–Ω–∏ —â–µ —Ä–∞–∑</span>
            </esp-web-install-button>

            <div class="info-box">
                <div class="info-title">üí° –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î</div>
                <div class="info-text">
                    –ü—ñ—Å–ª—è –ø—Ä–æ—à–∏–≤–∫–∏ –ø—Ä–∏—Å—Ç—Ä—ñ–π –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å—Å—è –∑ –Ω–æ–≤–æ—é –û–°. –ù–∞ –∫—Ä–æ—Ü—ñ 3 –≤—ñ–Ω –ø–æ–ø—Ä–æ—Å–∏—Ç—å
                    –¥–∞–Ω—ñ WiFi —á–µ—Ä–µ–∑ Improv ‚Äî —Å—Ç–æ—Ä—ñ–Ω–∫–∞ –≤—ñ–¥–∫—Ä–∏—î –≤—ñ–∫–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.
                </div>
            </div>
        </div>

        <!-- Step 3: WiFi -->
        <div class="step">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ WiFi</div>
            </div>
            <p class="step-desc">
                –ü—ñ—Å–ª—è –ø—Ä–æ—à–∏–≤–∫–∏ –Ω–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ. –ó º—è–≤–∏—Ç—å—Å—è Improv-–º–∞–π—Å—Ç–µ—Ä: –æ–±–µ—Ä–∏ –º–µ—Ä–µ–∂—É —Ç–∞ –≤–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å.
            </p>
            <improv-wifi-serial-launch-button id="wifiLauncher">
                <button slot="activate" class="btn-flash btn-wifi" id="wifiBtnInner" disabled>
                    üì° –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ WiFi
                </button>
                <span slot="unsupported">–ü–æ—Ç—Ä—ñ–±–µ–Ω Chrome –∞–±–æ Edge</span>
            </improv-wifi-serial-launch-button>
            <div class="info-box" id="wifiStatusBox" hidden>
                <div class="info-title">üì° –°—Ç–∞—Ç—É—Å WiFi</div>
                <div class="info-text" id="wifiStatusText"></div>
            </div>
        </div>

        <!-- Features -->
        <div class="feature-list">
            <div class="feature-item">
                <span class="feature-icon">üì∂</span>
                <span>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Å–∫–∞–Ω WiFi –º–µ—Ä–µ–∂</span>
            </div>
            <div class="feature-item">
                <span class="feature-icon">‚úÖ</span>
                <span>–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ</span>
            </div>
            <div class="feature-item">
                <span class="feature-icon">üîÑ</span>
                <span>–ú–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ WiFi –ø—ñ–∑–Ω—ñ—à–µ</span>
            </div>
        </div>

        <div class="info-box" style="margin-top: 24px;">
            <div class="info-title">‚ö†Ô∏è –Ø–∫—â–æ –Ω–µ –ø—Ä–æ—à–∏–≤–∞—î—Ç—å—Å—è</div>
            <div class="info-text">
                –£—Ç—Ä–∏–º—É–π –∫–Ω–æ–ø–∫—É <strong>BOOT</strong> –Ω–∞ –ø–ª–∞—Ç—ñ, –Ω–∞—Ç–∏—Å–∫–∞—é—á–∏ ¬´–ü—Ä–æ—à–∏—Ç–∏ ESP32¬ª. –í—ñ–¥–ø—É—Å—Ç–∏ BOOT, –∫–æ–ª–∏ –ø—Ä–æ—Ü–µ—Å –ø–æ—á–Ω–µ—Ç—å—Å—è.
            </div>
        </div>

        <div class="footer">
            <a href="/" class="footer-link">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
        </div>
    </div>

    <script>
        const SERVER = 'https://power-monitor.club';
        let currentDeviceId = '';

        const wifiLauncher = document.getElementById('wifiLauncher');
        const wifiBtnInner = document.getElementById('wifiBtnInner');
        const wifiStatusBox = document.getElementById('wifiStatusBox');
        const wifiStatusText = document.getElementById('wifiStatusText');

        wifiBtnInner.addEventListener('click', (event) => {
            if (wifiBtnInner.disabled) {
                event.preventDefault();
                event.stopPropagation();
            }
        });

        wifiLauncher.addEventListener('closed', (event) => {
            handleWifiResult(event.detail || {});
        });

        function generateId(name) {
            const slug = name.toLowerCase()
                .replace(/[–∞-—è—ñ—ó—î“ë]/g, c => {
                    const map = {'–∞':'a','–±':'b','–≤':'v','–≥':'h','“ë':'g','–¥':'d','–µ':'e','—î':'ye','–∂':'zh','–∑':'z','–∏':'y','—ñ':'i','—ó':'yi','–π':'y','–∫':'k','–ª':'l','–º':'m','–Ω':'n','–æ':'o','–ø':'p','—Ä':'r','—Å':'s','—Ç':'t','—É':'u','—Ñ':'f','—Ö':'kh','—Ü':'ts','—á':'ch','—à':'sh','—â':'shch','—å':'','—é':'yu','—è':'ya'};
                    return map[c] || c;
                })
                .replace(/[^a-z0-9]+/g, '_')
                .replace(/^_|_$/g, '')
                .substring(0, 20);
            const hash = Math.random().toString(36).substring(2, 6);
            return slug + '_' + hash;
        }

        function updateFlashButton() {
            const name = document.getElementById('deviceName').value.trim();
            const btn = document.getElementById('flashBtnInner');
            const flashBtn = document.getElementById('flashBtn');
            const wifiBtn = document.getElementById('wifiBtnInner');

            if (name.length >= 3) {
                btn.disabled = false;
                currentDeviceId = generateId(name);
                wifiBtn.disabled = false;

                const params = new URLSearchParams({
                    device: currentDeviceId,
                    name: name,
                    server: '178.62.112.232',
                    improv: 'true'
                });

                // Add owner if logged in
                fetch('/api/me').then(r => r.ok ? r.json() : null).then(data => {
                    if (data?.email) params.set('owner', data.email);
                }).finally(() => {
                    flashBtn.setAttribute('manifest', SERVER + '/api/manifest?' + params.toString());
                });
                setWifiStatus('', { hidden: true });
            } else {
                btn.disabled = true;
                currentDeviceId = '';
                wifiBtn.disabled = true;
                setWifiStatus('', { hidden: true });
            }
        }

        function setWifiStatus(message, options = {}) {
            const { hidden = false, tone } = options;
            wifiStatusBox.classList.remove('success', 'error');
            if (hidden || !message) {
                wifiStatusBox.hidden = true;
                wifiStatusText.textContent = '';
                return;
            }
            wifiStatusBox.hidden = false;
            if (tone === 'success') wifiStatusBox.classList.add('success');
            if (tone === 'error') wifiStatusBox.classList.add('error');
            wifiStatusText.textContent = message;
        }

        async function handleWifiResult(detail) {
            if (!detail?.improv) {
                setWifiStatus('–ü—Ä–∏—Å—Ç—Ä—ñ–π –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–≤ —á–µ—Ä–µ–∑ Improv. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ –≤—ñ–Ω –ø—Ä–æ—à–∏—Ç–∏–π —Ü—ñ—î—é —Å—Ç–æ—Ä—ñ–Ω–∫–æ—é.', { tone: 'error' });
                return;
            }
            if (!detail.provisioned) {
                setWifiStatus('–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è WiFi —Å–∫–∞—Å–æ–≤–∞–Ω–æ. –°–ø—Ä–æ–±—É–π —â–µ —Ä–∞–∑.', { tone: 'error' });
                return;
            }

            let claimed = false;
            if (currentDeviceId) {
                claimed = await claimDevice(currentDeviceId);
            }

            const successMessage = claimed
                ? 'WiFi –∑–±–µ—Ä–µ–∂–µ–Ω–æ, –ø—Ä–∏—Å—Ç—Ä—ñ–π –¥–æ–¥–∞–Ω–æ –¥–æ –∞–∫–∞—É–Ω—Ç–∞. –í—ñ–¥–∫—Ä–∏–≤–∞—é –¥–∞—à–±–æ—Ä–¥‚Ä¶'
                : 'WiFi –∑–±–µ—Ä–µ–∂–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä –ø—Ä–∏—Å—Ç—Ä—ñ–π —É –¥–∞—à–±–æ—Ä–¥—ñ.';

            setWifiStatus(successMessage, { tone: 'success' });

            if (claimed) {
                setTimeout(() => {
                    window.location.href = '/dashboard';
                }, 2000);
            }
        }

        async function claimDevice(deviceId) {
            try {
                const res = await fetch('/api/claim?device=' + encodeURIComponent(deviceId));
                return res.ok;
            } catch (err) {
                console.error('Claim failed:', err);
                return false;
            }
        }

        // Reset flash button after install completes
        const flashBtn = document.getElementById('flashBtn');
        flashBtn.addEventListener('state-changed', (e) => {
            if (e.detail.state === 'INSTALLED' || e.detail.state === 'ERROR') {
                // Recreate button to reset internal state
                setTimeout(() => {
                    const parent = flashBtn.parentNode;
                    const manifest = flashBtn.getAttribute('manifest');
                    const newBtn = document.createElement('esp-web-install-button');
                    newBtn.id = 'flashBtn';
                    newBtn.innerHTML = `
                        <button slot="activate" class="btn-flash" id="flashBtnInner">
                            ‚ö° –ü—Ä–æ—à–∏—Ç–∏ ESP32
                        </button>
                        <span slot="unsupported">–ü–æ—Ç—Ä—ñ–±–µ–Ω Chrome –∞–±–æ Edge</span>
                        <span slot="not-allowed">–ù–∞—Ç–∏—Å–Ω–∏ —â–µ —Ä–∞–∑</span>
                    `;
                    if (manifest) newBtn.setAttribute('manifest', manifest);
                    parent.replaceChild(newBtn, flashBtn);
                    // Re-attach listener to new button
                    newBtn.addEventListener('state-changed', arguments.callee);
                }, 1000);
            }
        });
    </script>
</body>
</html>
